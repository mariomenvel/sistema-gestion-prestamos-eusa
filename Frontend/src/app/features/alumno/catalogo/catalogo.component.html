<div class="catalogo">

  <!-- T√çTULO -->
  <h1 class="catalogo-title">Cat√°logo</h1>

  <!-- BARRA DE B√öSQUEDA Y FILTROS R√ÅPIDOS -->
  <div class="search-filters-row">

    <!-- Barra de b√∫squeda -->
    <div class="search-bar">
      <input type="text" class="search-input" placeholder="Buscar Libros, c√°maras, micr√≥fonos..."
        [(ngModel)]="textoBusqueda" (keyup.enter)="buscar()">
      <button class="search-icon" (click)="buscar()">üîç</button>
    </div>

    <!-- Filtros r√°pidos -->
    <div class="quick-filters">
      <button class="filter-btn" [class.active]="filtroTipoActivo === 'todos'" (click)="cambiarFiltroTipo('todos')">
        Todos
      </button>

      <button class="filter-btn" [class.active]="filtroTipoActivo === 'libros'" (click)="cambiarFiltroTipo('libros')">
        Libros
      </button>

      <button class="filter-btn" [class.active]="filtroTipoActivo === 'equipos'" (click)="cambiarFiltroTipo('equipos')">
        Material Audiovisual
      </button>
    </div>

  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="catalogo-content">

    <!-- PANEL LATERAL DE FILTROS -->
    <aside class="filters-panel">
      <h2 class="filters-title">Filtros</h2>

      <!-- Tipo de Material -->
      <div class="filter-section">
        <h3 class="filter-section-title">Tipo de Material</h3>
        <div class="filter-divider"></div>

        <label class="checkbox-label">
          <input type="checkbox" [checked]="filtroTipoActivo === 'libros'" (change)="cambiarFiltroTipo('libros')">
          <span>Libros</span>
        </label>

        <label class="checkbox-label">
          <input type="checkbox" [checked]="filtroTipoActivo === 'equipos'" (change)="cambiarFiltroTipo('equipos')">
          <span>Material Audiovisual</span>
        </label>
      </div>

      <!-- Filtro por Categor√≠a de Equipo (Solo para Audiovisual) -->
      <div class="filter-section" *ngIf="filtroTipoActivo === 'equipos'">
        <h3 class="filter-section-title">Categor√≠a</h3>
        <div class="filter-divider"></div>

        <div class="checkbox-group">
          <label class="checkbox-label" *ngFor="let cat of categoriasEquipos">
            <input type="checkbox" [checked]="isCategoriaEquipoSeleccionada(cat.id)"
              (change)="toggleCategoriaEquipo(cat.id)">
            <span>{{ cat.nombre }}</span>
          </label>
        </div>
      </div>

      <!-- Filtro por Nombre de Equipo (Solo para Audiovisual) -->
      <div class="filter-section" *ngIf="filtroTipoActivo === 'equipos'">
        <h3 class="filter-section-title">Nombre de Equipo</h3>
        <div class="filter-divider"></div>

        <div class="checkbox-group">
          <label class="checkbox-label" *ngFor="let nombre of nombresEquipo">
            <input type="checkbox" [checked]="isNombreSeleccionado(nombre.id)" (change)="toggleNombreEquipo(nombre.id)">
            <span>{{ nombre.nombre }}</span>
          </label>
        </div>
      </div>

      <!-- Filtro por G√©nero (Solo para Libros) -->
      <div class="filter-section" *ngIf="filtroTipoActivo === 'libros'">
        <h3 class="filter-section-title">G√©nero</h3>
        <div class="filter-divider"></div>

        <div class="checkbox-group">
          <label class="checkbox-label" *ngFor="let genero of generos">
            <input type="checkbox" [checked]="isGeneroSeleccionado(genero.id)" (change)="toggleGenero(genero.id)">
            <span>{{ genero.nombre }}</span>
          </label>
        </div>
      </div>
    </aside>

    <!-- GRID DE MATERIALES -->
    <main class="materials-grid">

      <!-- Loading -->
      <div *ngIf="isLoading" class="loading-state">
        Cargando materiales...
      </div>

      <!-- Error -->
      <div *ngIf="errorMessage" class="error-state">
        {{ errorMessage }}
      </div>

      <!-- Sin resultados -->
      <div *ngIf="!isLoading && !errorMessage && materialesFiltrados.length === 0" class="empty-state">
        No se encontraron materiales con los filtros seleccionados.
      </div>

      <!-- Cards de materiales -->
      <article class="material-card" *ngFor="let material of materialesFiltrados">

        <!-- Imagen y Info clickable para Detalle -->
        <div class="card-clickable-area" (click)="verDetalle(material)">
          <!-- Imagen -->
          <div class="material-image">
            <img *ngIf="material.imagenUrl" [src]="material.imagenUrl" [alt]="material.titulo">
            <div *ngIf="!material.imagenUrl" class="image-placeholder">
              {{ material.tipo === 'libro' ? 'üìö' : 'üì∑' }}
            </div>
          </div>

          <!-- Informaci√≥n -->
          <div class="material-info">
            <h3 class="material-title">{{ material.titulo }}</h3>
            <p class="material-category">{{ material.categoria }}</p>
            <p class="material-brand">{{ material.marcaModelo }}</p>
            <p class="material-description">{{ material.descripcion }}</p>
          </div>
        </div>

        <div class="material-footer">
          <button class="btn-solicitar" [disabled]="!material.disponible" (click)="agregarAlCarrito(material)">
            <i class="fas" [ngClass]="estaEnCarrito(material) ? 'fa-check' : 'fa-shopping-cart'"></i>
            {{ estaEnCarrito(material) ? 'En el carrito' : 'Solicitar' }}
          </button>
        </div>

      </article>

    </main>

  </div>

  <!-- BOT√ìN FLOTANTE DEL CARRITO -->
  <div class="cart-floating-btn" *ngIf="carrito.length > 0" (click)="abrirCarrito()">
    <div class="cart-icon-wrapper">
      <i class="fas fa-shopping-basket"></i>
      <span class="cart-badge">{{ carrito.length }}</span>
    </div>
    <span class="cart-text">Ver Mi Carrito</span>
  </div>

  <!-- NOTIFICACI√ìN DE CARRITO ACTUALIZADO -->
  <div class="cart-notification" [class.show]="mostrarNotificacionCarrito">
    <div class="notification-content">
      <div class="notification-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="notification-info">
        <p class="notification-title">Agregado al Carrito</p>
        <p class="notification-desc">{{ ultimoMaterialAgregado?.titulo }}</p>
      </div>
    </div>
  </div>

</div>

<!-- MODAL DE DETALLE / INFO -->
<div class="modal-overlay" *ngIf="mostrarModalDetalle" (click)="cerrarModalDetalle()">
  <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
    <!-- Cabecera -->
    <div class="modal-header">
      <div class="header-info">
        <span class="material-type-badge" [class]="materialSeleccionado?.tipo">
          {{ materialSeleccionado?.tipo === 'libro' ? 'Libro' : 'Material Audiovisual' }}
        </span>
        <h2 class="modal-title">{{ materialSeleccionado?.titulo }}</h2>
      </div>
      <button class="btn-close" (click)="cerrarModalDetalle()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Cuerpo del Modal -->
    <div class="modal-body">
      <div class="detail-container">
        <!-- Imagen -->
        <div class="detail-image-section">
          <div class="image-wrapper">
            <img [src]="materialSeleccionado?.imagenUrl || 'assets/images/placeholder-material.png'"
              [alt]="materialSeleccionado?.titulo" onerror="this.src='assets/images/placeholder-material.png'">
          </div>
          <div class="status-badge" [class.available]="materialSeleccionado?.disponible">
            <i class="fas" [ngClass]="materialSeleccionado?.disponible ? 'fa-check-circle' : 'fa-times-circle'"></i>
            {{ materialSeleccionado?.disponible ? 'Disponible' : 'No disponible' }}
          </div>
        </div>

        <!-- Informaci√≥n -->
        <div class="detail-info-section">
          <div class="info-grid">
            <!-- Info espec√≠fica Libros -->
            <ng-container *ngIf="materialSeleccionado?.tipo === 'libro'">
              <div class="info-item">
                <label>Autor</label>
                <span>{{ materialSeleccionado?.autor || 'Desconocido' }}</span>
              </div>
              <div class="info-item">
                <label>Editorial</label>
                <span>{{ materialSeleccionado?.editorial || 'Desconocida' }}</span>
              </div>
              <div class="info-item">
                <label>N√∫mero de Registro</label>
                <span>{{ materialSeleccionado?.libro_numero }}</span>
              </div>
              <div class="info-item">
                <label>G√©nero</label>
                <span>{{ materialSeleccionado?.categoria }}</span>
              </div>
            </ng-container>

            <!-- Info espec√≠fica Equipos -->
            <ng-container *ngIf="materialSeleccionado?.tipo === 'equipo'">
              <div class="info-item">
                <label>Marca</label>
                <span>{{ materialSeleccionado?.marca }}</span>
              </div>
              <div class="info-item">
                <label>Modelo</label>
                <span>{{ materialSeleccionado?.modelo }}</span>
              </div>
              <div class="info-item">
                <label>Nombre Gen√©rico</label>
                <span>{{ materialSeleccionado?.nombre_equipo }}</span>
              </div>
              <div class="info-item">
                <label>Categor√≠a</label>
                <span>{{ materialSeleccionado?.categoria }}</span>
              </div>
            </ng-container>
          </div>

          <div class="description-section">
            <label>Descripci√≥n</label>
            <p>{{ materialSeleccionado?.descripcion }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pie del Modal -->
    <div class="modal-footer">
      <button class="btn-cancel" (click)="cerrarModalDetalle()">Cerrar</button>
      <button class="btn-solicitar" [disabled]="!materialSeleccionado?.disponible"
        (click)="agregarAlCarrito(materialSeleccionado!)">
        <i class="fas" [ngClass]="estaEnCarrito(materialSeleccionado) ? 'fa-check' : 'fa-shopping-cart'"></i>
        {{ estaEnCarrito(materialSeleccionado) ? 'Ya en el Carrito' : 'A√±adir al Carrito' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE FORMALIZACI√ìN (Checkout) -->
<app-solicitar-prestamo [isOpen]="mostrarModalSolicitud" [material]="materialSeleccionado" [listaCarrito]="carrito"
  [todosLosMateriales]="materiales" (close)="cerrarModalSolicitud()" (solicitudCreada)="onSolicitudCreada()"
  (vaciarCarrito)="vaciarCarrito()" (quitarItem)="quitarDelCarrito($event.id, $event.tipo)"
  (actualizarCantidad)="actualizarCantidad($event.id, $event.tipo, $event.delta)"></app-solicitar-prestamo>