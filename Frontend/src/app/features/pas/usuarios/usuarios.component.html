<!-- Gestión de Usuarios PAS -->
<div class="usuarios">

  <!-- Título principal -->
  <h1 class="page-title">Gestión de Usuarios</h1>

  <!-- Barra de búsqueda -->
  <div class="busqueda">
    <input type="text" class="input-busqueda" placeholder="Buscar alumno..." [(ngModel)]="textoBusqueda"
      (input)="buscar()" />
  </div>

  <!-- Tabla de usuarios -->
  <div class="table-container">

    <!-- Header tabla -->
    <div class="table-header">
      <div class="th th-nombre">Nombre</div>
      <div class="th th-email">Email</div>
      <div class="th th-grado">Grado</div>
      <div class="th th-curso">Curso</div>
      <div class="th th-tipob">
        Tipo B
        <span class="info-icon" title="Cada alumno tiene un máximo de 5 préstamos tipo B por trimestre">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" class="feather feather-info">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
        </span>
      </div>
      <div class="th th-estado">Estado</div>
    </div>

    <!-- Body tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <p>Cargando usuarios...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin usuarios -->
      <div class="empty-state" *ngIf="!isLoading && !errorMessage && usuariosFiltrados.length === 0">
        <p>No hay usuarios disponibles</p>
      </div>

      <!-- Filas de usuarios -->
      <div class="table-row" *ngFor="let usuario of usuariosFiltrados" (click)="abrirModalEditar(usuario)">
        <!-- Nombre (clickeable) -->
        <div class="td td-nombre">
          <span class="nombre-clickeable">{{ usuario.nombre }} {{ usuario.apellidos }}</span>
        </div>

        <!-- Email -->
        <div class="td td-email">
          {{ usuario.email }}
        </div>

        <!-- Grado -->
        <div class="td td-grado">
          {{ getTipoEstudiosLabel(usuario.tipo_estudios || '') }}
        </div>

        <!-- Curso -->
        <div class="td td-curso">
          -
        </div>

        <!-- Tipo B -->
        <div class="td td-tipob">
          {{ getContadorTipoB(usuario.id) }}
        </div>

        <!-- Estado -->
        <div class="td td-estado">
          {{ getEstadoLabel(usuario.estado_perfil) }}
        </div>
      </div>

    </div>

  </div>

</div>

<!-- MODAL DE EDICIÓN -->
<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Título del modal -->
    <h2 class="modal-title">Perfil</h2>

    <!-- SECCIÓN: Código de Barras Personal -->
    <div class="codigo-barras-section" *ngIf="usuarioSeleccionado">
      <div class="codigo-barras-label">Código de Barras Personal:</div>
      <div class="codigo-barras-container">
        <svg id="barcodeModal"></svg>
      </div>
    </div>

    <!-- Formulario -->
    <form [formGroup]="formularioUsuario" (ngSubmit)="guardarCambios()">

      <!-- Campo: Nombre Completo -->
      <div class="form-field">
        <label class="field-label">Nombre Completo</label>
        <input type="text" class="field-input" formControlName="nombre" />
      </div>

      <!-- Campo: Email -->
      <div class="form-field">
        <label class="field-label">Email</label>
        <input type="email" class="field-input" formControlName="email" />
      </div>

      <!-- Campo: Año de Matrícula -->
      <div class="form-field">
        <label class="field-label">Año de Matrícula</label>
        <input type="date" class="field-input" formControlName="fecha_inicio_est" />
      </div>

      <!-- Campo: Tipo de Estudios -->
      <div class="form-field">
        <label class="field-label">Tipo de Estudios</label>
        <select class="field-select" formControlName="tipo_estudios">
          <option value="">Seleccionar...</option>
          <option *ngFor="let opcion of opcionesTipoEstudios" [value]="opcion.valor">
            {{ opcion.etiqueta }}
          </option>
        </select>
      </div>

      <!-- Campo: Nombre del Grado -->
      <div class="form-field">
        <label class="field-label">Nombre del Grado</label>
        <input type="text" class="field-input" formControlName="apellidos" />
      </div>

      <!-- Campo: Curso -->
      <div class="form-field">
        <label class="field-label">Curso</label>
        <select class="field-select" disabled>
          <option value="">-</option>
        </select>
      </div>

      <!-- Campo: Fecha Estimada de Finalización -->
      <div class="form-field">
        <label class="field-label">Fecha Estimada de Finalización</label>
        <input type="date" class="field-input" formControlName="fecha_fin_prev" />
      </div>

      <!-- Campo: Estado del Perfil -->
      <div class="form-field">
        <label class="field-label">Estado del Perfil</label>
        <select class="field-select" formControlName="estado_perfil">
          <option *ngFor="let opcion of opcionesEstado" [value]="opcion.valor">
            {{ opcion.etiqueta }}
          </option>
        </select>
      </div>

      <!-- Botones -->
      <div class="modal-actions">
        <button type="button" class="btn-cancelar" (click)="cerrarModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-guardar" [disabled]="guardando || formularioUsuario.invalid">
          {{ guardando ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>

    </form>

  </div>
</div>