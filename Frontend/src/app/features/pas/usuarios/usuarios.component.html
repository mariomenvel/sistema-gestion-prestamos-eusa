<!-- Gestión de Usuarios PAS -->
<div class="usuarios">

  <!-- Título principal -->
  <h1 class="page-title">Gestión de Usuarios</h1>

  <!-- Barra de búsqueda y filtros -->
  <div class="filtros-container">
    <div class="busqueda-wrapper">
      <input type="text" class="input-busqueda" placeholder="Buscar por nombre o email..." [(ngModel)]="textoBusqueda"
        (input)="aplicarFiltros()" />
    </div>

    <div class="selects-wrapper">
      <!-- Filtro Estado -->
      <select class="select-filtro" [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
        <option value="">Todos los Estados</option>
        <option *ngFor="let opcion of opcionesEstado" [value]="opcion.valor">
          {{ opcion.etiqueta }}
        </option>
      </select>

      <!-- Botón Limpiar -->
      <button class="btn-limpiar" (click)="textoBusqueda=''; filtroEstado=''; aplicarFiltros()"
        title="Limpiar todos los filtros" aria-label="Limpiar todos los filtros">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="table-container">

    <!-- Header tabla -->
    <div class="table-header">
      <div class="th th-nombre sortable" (click)="ordenar('nombre')">
        Nombre
        <span class="sort-icon" [class.active]="sortColumn === 'nombre'">
          {{ sortColumn === 'nombre' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-email sortable" (click)="ordenar('email')">
        Email
        <span class="sort-icon" [class.active]="sortColumn === 'email'">
          {{ sortColumn === 'email' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-telefono">Teléfono</div>
      <div class="th th-grado sortable" (click)="ordenar('grado')">
        Grado
        <span class="sort-icon" [class.active]="sortColumn === 'grado'">
          {{ sortColumn === 'grado' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-curso">Curso</div>
      <div class="th th-tipob sortable" (click)="ordenar('tipob')">
        Tipo B
        <span class="sort-icon" [class.active]="sortColumn === 'tipob'">
          {{ sortColumn === 'tipob' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-estado sortable" (click)="ordenar('estado')">
        Estado
        <span class="sort-icon" [class.active]="sortColumn === 'estado'">
          {{ sortColumn === 'estado' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
    </div>

    <!-- Body tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Cargando usuarios...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin usuarios -->
      <div class="empty-state" *ngIf="!isLoading && !errorMessage && usuariosFiltrados.length === 0">
        <p>No hay usuarios disponibles</p>
      </div>

      <!-- Filas de usuarios -->
      <div class="table-row" *ngFor="let usuario of usuariosFiltrados" (click)="abrirModalEditar(usuario)"
        (keydown.enter)="abrirModalEditar(usuario)" (keydown.space.prevent)="abrirModalEditar(usuario)" tabindex="0"
        role="button" [attr.aria-label]="'Editar usuario ' + usuario.nombre + ' ' + usuario.apellidos">
        <!-- Nombre (clickeable) -->
        <div class="td td-nombre">
          <span class="nombre-clickeable">{{ usuario.nombre }} {{ usuario.apellidos }}</span>
        </div>

        <!-- Email -->
        <div class="td td-email">
          {{ usuario.email }}
        </div>

        <!-- Teléfono -->
        <div class="td td-telefono">
          {{ usuario.telefono || '-' }}
        </div>

        <!-- Grado -->
        <div class="td td-grado">
          {{ getTipoEstudiosLabel(usuario.tipo_estudios || '') }}
        </div>

        <!-- Curso -->
        <div class="td td-curso">
          {{ usuario.curso ? usuario.curso + 'º' : '-' }}
        </div>

        <!-- Tipo B -->
        <div class="td td-tipob">
          {{ getContadorTipoB(usuario.id) }}
        </div>

        <!-- Estado -->
        <div class="td td-estado">
          <span class="badge-estado" [ngClass]="usuario.estado_perfil">
            {{ getEstadoLabel(usuario.estado_perfil) }}
          </span>
        </div>
      </div>

    </div>

  </div>

</div>

<!-- MODAL DE EDICIÓN -->
<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()" role="dialog" aria-modal="true"
  aria-labelledby="titulo-editar-usuario">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Título del modal -->
    <h2 class="modal-title" id="titulo-editar-usuario">Perfil</h2>

    <!-- SECCIÓN: Código de Barras Personal -->
    <div class="codigo-barras-section" *ngIf="usuarioSeleccionado">
      <div class="codigo-barras-label">Código de Barras Personal:</div>
      <div class="codigo-barras-container">
        <!-- Si tiene código de tarjeta -->
        <svg id="barcodeModal" *ngIf="usuarioSeleccionado.codigo_tarjeta"></svg>

        <!-- Si NO tiene código de tarjeta -->
        <div class="sin-codigo" *ngIf="!usuarioSeleccionado.codigo_tarjeta">
          <p>Este usuario no tiene código de tarjeta asignado</p>
        </div>
      </div>
    </div>

    <!-- Formulario -->
    <form [formGroup]="formularioUsuario" (ngSubmit)="guardarCambios()">

      <!-- Campo: Nombre -->
      <div class="form-field">
        <label class="field-label" for="campo-nombre">Nombre</label>
        <input type="text" id="campo-nombre" class="field-input" formControlName="nombre" />
      </div>

      <!-- Campo: Apellidos -->
      <div class="form-field">
        <label class="field-label" for="campo-apellidos">Apellidos</label>
        <input type="text" id="campo-apellidos" class="field-input" formControlName="apellidos" />
      </div>

      <!-- Campo: Email -->
      <div class="form-field">
        <label class="field-label">Email</label>
        <input type="email" class="field-input" formControlName="email" />
      </div>

      <!-- Campo: Teléfono -->
      <div class="form-field">
        <label class="field-label">Teléfono</label>
        <input type="text" class="field-input" formControlName="telefono" />
      </div>

      <!-- Campo: Año de Matrícula -->
      <div class="form-field">
        <label class="field-label">Año de Matrícula</label>
        <input type="date" class="field-input" formControlName="fecha_inicio_est" />
      </div>

      <!-- Campo: Tipo de Estudios -->
      <div class="form-field">
        <label class="field-label">Tipo de Estudios</label>
        <select class="field-select" formControlName="tipo_estudios">
          <option value="">Seleccionar...</option>
          <option *ngFor="let opcion of opcionesTipoEstudios" [value]="opcion.valor">
            {{ opcion.etiqueta }}
          </option>
        </select>
      </div>

      <!-- Campo: Nombre del Grado -->
      <div class="form-field">
        <label class="field-label">Nombre del Grado</label>
        <input type="text" class="field-input" formControlName="grado" />
      </div>

      <div class="form-field">
        <label class="field-label">Curso</label>
        <input type="text" class="field-input" formControlName="curso" readonly />
      </div>

      <!-- Campo: Fecha Estimada de Finalización -->
      <div class="form-field">
        <label class="field-label">Fecha Estimada de Finalización</label>
        <input type="date" class="field-input" formControlName="fecha_fin_prev" />
      </div>

      <!-- Campo: Estado del Perfil -->
      <div class="form-field">
        <label class="field-label">Estado del Perfil</label>
        <select class="field-select" formControlName="estado_perfil">
          <option *ngFor="let opcion of opcionesEstado" [value]="opcion.valor">
            {{ opcion.etiqueta }}
          </option>
        </select>
      </div>

      <!-- Botones -->
      <div class="modal-actions">
        <button type="button" class="btn-cancelar" (click)="cerrarModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-guardar" [disabled]="guardando || formularioUsuario.invalid">
          {{ guardando ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>

    </form>

  </div>
</div>

<!-- MODAL DE NOTIFICACIONES (Reutilizable) - FUERA del modal de edición -->
<app-modal [mostrar]="mostrarModalNotificacion" [tipo]="tipoModalNotificacion" [titulo]="tituloModalNotificacion"
  [mensaje]="mensajeModalNotificacion" [textoBtnPrincipal]="'Aceptar'" (cerrar)="cerrarModalNotificacion()"></app-modal>