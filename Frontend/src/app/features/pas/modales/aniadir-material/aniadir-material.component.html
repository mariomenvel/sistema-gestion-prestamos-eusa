<!-- Modal Overlay -->
<div class="modal-overlay" *ngIf="isOpen" (click)="cerrarModal()">

  <!-- Modal Container -->
  <div class="modal-container" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="modal-header">
      <h2 class="modal-title">A√±adir Nuevo Material</h2>
      <button class="btn-close" (click)="cerrarModal()" type="button">‚úï</button>
    </div>

    <!-- Body -->
    <div class="modal-body">

      <!-- Selector de Tipo -->
      <div class="tipo-selector">
        <button type="button" class="btn-tipo-selector" [class.activo]="tipoMaterial === 'equipo'"
          (click)="cambiarTipo('equipo')">
          Equipo
        </button>
        <button type="button" class="btn-tipo-selector" [class.activo]="tipoMaterial === 'libro'"
          (click)="cambiarTipo('libro')">
          Libro
        </button>
      </div>

      <!-- FORMULARIO EQUIPO -->
      <form class="material-form" *ngIf="tipoMaterial === 'equipo'">

        <h3 class="section-title">Informaci√≥n del Equipo</h3>

        <!-- Grid de campos principales -->
        <div class="form-grid">

          <!-- Nombre Gen√©rico -->
          <div class="form-field">
            <div class="field-with-button">
              <div class="field-content">
                <label class="form-label">Nombre Gen√©rico *</label>
                <select class="form-select" [(ngModel)]="equipoNombreId" name="equipoNombreId">
                  <option value="">Seleccionar nombre</option>
                  <option *ngFor="let n of nombresEquipos" [value]="n.id">
                    {{ n.nombre }}
                  </option>
                </select>
              </div>
              <button type="button" class="btn-nueva-categoria" (click)="toggleFormularioNombre()"
                [title]="mostrarFormularioNombre ? 'Cancelar' : 'A√±adir nuevo nombre'">
                {{ mostrarFormularioNombre ? '‚úï' : '+' }}
              </button>
            </div>

            <!-- Formulario nuevo nombre -->
            <div class="nueva-categoria-form" *ngIf="mostrarFormularioNombre">
              <h4>Nuevo Nombre Gen√©rico</h4>
              <div class="nueva-categoria-campos">
                <input type="text" class="form-input" [(ngModel)]="nuevoNombreTexto" name="nuevoNombreTexto"
                  placeholder="Ej: C√°mara Reflex" style="grid-column: 1 / 3;">
                <button type="button" class="btn-crear-categoria" (click)="crearNombre()">
                  Crear
                </button>
              </div>
            </div>
          </div>

          <!-- Categor√≠a -->
          <div class="form-field">
            <div class="field-with-button">
              <div class="field-content">
                <label class="form-label">Categor√≠a *</label>
                <select class="form-select" [(ngModel)]="equipoCategoria" name="equipoCategoria">
                  <option value="">Seleccionar categor√≠a</option>
                  <option *ngFor="let cat of categoriasEquipos" [value]="cat.id">
                    {{ cat.nombre }}
                  </option>
                </select>
              </div>
              <button type="button" class="btn-nueva-categoria" (click)="toggleFormularioCategoria()"
                title="A√±adir nueva categor√≠a">
                {{ mostrarFormularioCategoria ? '‚úï' : '+' }}
              </button>
            </div>

            <!-- Formulario nueva categor√≠a EQUIPOS -->
            <div class="nueva-categoria-form" *ngIf="mostrarFormularioCategoria">
              <h4>Nueva Categor√≠a de Equipo</h4>
              <div class="nueva-categoria-campos">
                <input type="text" class="form-input" [(ngModel)]="nuevaCategoriaNombre" name="nuevaCategoriaNombre"
                  placeholder="Nombre de la categor√≠a (Ej: V√≠deo)" style="grid-column: 1 / 3;">
                <button type="button" class="btn-crear-categoria" (click)="crearCategoria()">
                  Crear
                </button>
              </div>
            </div>
          </div>

          <!-- Marca -->
          <div class="form-field">
            <label class="form-label">Marca *</label>
            <input type="text" class="form-input" [(ngModel)]="equipoMarca" name="equipoMarca" placeholder="Ej: Canon">
          </div>

          <!-- Modelo -->
          <div class="form-field">
            <label class="form-label">Modelo *</label>
            <input type="text" class="form-input" [(ngModel)]="equipoModelo" name="equipoModelo"
              placeholder="Ej: EOS 250D">
          </div>

          <!-- Descripci√≥n -->
          <div class="form-field form-field-full">
            <label class="form-label">Descripci√≥n</label>
            <textarea class="form-textarea" [(ngModel)]="equipoDescripcion" name="equipoDescripcion" rows="3"
              placeholder="Descripci√≥n opcional del equipo"></textarea>
          </div>

        </div>

        <!-- Imagen -->
        <div class="form-field">
          <label class="form-label">Imagen del Equipo</label>

          <div class="imagen-container" *ngIf="imagenPreview">
            <img [src]="imagenPreview" alt="Preview">
          </div>

          <input type="file" id="inputImagenEquipo" accept="image/*" (change)="onImagenSeleccionada($event)"
            style="display: none;">

          <label for="inputImagenEquipo" class="btn-seleccionar-archivo">
            üì∑ Seleccionar imagen
          </label>
          <p class="help-text">Formatos: JPG, PNG, GIF (m√°x. 5MB)</p>
        </div>

        <!-- Separador -->
        <hr class="separador">

        <!-- Unidades -->
        <div class="unidades-section">
          <div class="section-header">
            <h3 class="section-title">Unidades del Equipo *</h3>
            <button type="button" class="btn-agregar-item" (click)="agregarUnidad()">
              + A√±adir unidad
            </button>
          </div>

          <div class="unidades-list">
            <div class="unidad-item" *ngFor="let unidad of unidades; let i = index">

              <div class="item-numero">{{ i + 1 }}.</div>

              <div class="item-campos">

                <!-- N√∫mero de Serie -->
                <div class="item-campo">
                  <label>N¬∞ Serie:</label>
                  <input type="text" class="item-input" [(ngModel)]="unidad.numero_serie" [name]="'unidad_serie_' + i"
                    placeholder="Opcional">
                </div>

                <!-- C√≥digo de Barras -->
                <div class="item-campo">
                  <label>C√≥digo de Barras: *</label>
                  <input type="text" class="item-input" [(ngModel)]="unidad.codigo_barra" [name]="'unidad_codigo_' + i"
                    placeholder="Ej: EQ-CAM-001">
                </div>

                <!-- Estado -->
                <div class="item-campo">
                  <label>Estado F√≠sico:</label>
                  <select class="item-select" [(ngModel)]="unidad.estado_fisico" [name]="'unidad_estado_fisico_' + i">
                    <option *ngFor="let est of estadosFisicosEquipos" [value]="est.valor">
                      {{ est.texto }}
                    </option>
                  </select>
                </div>

              </div>

              <button type="button" class="btn-eliminar-item" (click)="eliminarUnidad(i)"
                [disabled]="unidades.length === 1" title="Eliminar unidad">
                üóëÔ∏è
              </button>

            </div>
          </div>

        </div>

      </form>

      <!-- FORMULARIO LIBRO -->
      <form class="material-form" *ngIf="tipoMaterial === 'libro'">

        <h3 class="section-title">Informaci√≥n del Libro</h3>

        <!-- Grid de campos principales -->
        <div class="form-grid">

          <!-- T√≠tulo -->
          <div class="form-field form-field-full">
            <label class="form-label">T√≠tulo *</label>
            <input type="text" class="form-input" [(ngModel)]="libroTitulo" name="libroTitulo"
              placeholder="Ej: Habilidades de Comunicaci√≥n">
          </div>

          <!-- Autor -->
          <div class="form-field">
            <label class="form-label">Autor</label>
            <input type="text" class="form-input" [(ngModel)]="libroAutor" name="libroAutor"
              placeholder="Ej: Fernando de Manuel">
          </div>

          <!-- Editorial -->
          <div class="form-field">
            <label class="form-label">Editorial</label>
            <input type="text" class="form-input" [(ngModel)]="libroEditorial" name="libroEditorial"
              placeholder="Ej: Marketing Editorial">
          </div>

          <!-- N√∫mero de Libro -->
          <div class="form-field">
            <label class="form-label">N√∫mero de Libro *</label>
            <input type="text" class="form-input" [(ngModel)]="libroNumero" name="libroNumero" placeholder="Ej: 00001">
          </div>

          <!-- Categor√≠a -->
          <div class="form-field">
            <div class="field-with-button">
              <div class="field-content">
                <label class="form-label">Categor√≠a *</label>
                <select class="form-select" [(ngModel)]="libroCategoria" name="libroCategoria">
                  <option value="">Seleccionar categor√≠a</option>
                  <option *ngFor="let cat of categoriasLibros" [value]="cat.id">
                    {{ cat.nombre }}
                  </option>
                </select>
              </div>
              <button type="button" class="btn-nueva-categoria" (click)="toggleFormularioCategoria()"
                title="A√±adir nueva categor√≠a">
                {{ mostrarFormularioCategoria ? '‚úï' : '+' }}
              </button>
            </div>

            <!-- Formulario nueva categor√≠a LIBROS -->
            <div class="nueva-categoria-form" *ngIf="mostrarFormularioCategoria">
              <h4>Nueva Categor√≠a de Libro</h4>
              <div class="nueva-categoria-campos">
                <input type="text" class="form-input" [(ngModel)]="nuevaCategoriaNombre" name="nuevaCategoriaNombre"
                  placeholder="Nombre de la categor√≠a (Ej: Marketing)" style="grid-column: 1 / 3;">
                <button type="button" class="btn-crear-categoria" (click)="crearCategoria()">
                  Crear
                </button>
              </div>
            </div>
          </div>

        </div>

        <!-- Imagen del Libro -->
        <div class="form-field">
          <label class="form-label">Portada del Libro</label>

          <div class="imagen-container" *ngIf="imagenPreview">
            <img [src]="imagenPreview" alt="Preview">
          </div>

          <input type="file" id="inputImagenLibro" accept="image/*" (change)="onImagenSeleccionada($event)"
            style="display: none;">

          <label for="inputImagenLibro" class="btn-seleccionar-archivo">
            üì∑ Seleccionar portada
          </label>
          <p class="help-text">Formatos: JPG, PNG, GIF (m√°x. 5MB)</p>
        </div>

        <!-- Separador -->
        <hr class="separador">

        <!-- Ejemplares -->
        <div class="ejemplares-section">
          <div class="section-header">
            <h3 class="section-title">Ejemplares del Libro *</h3>
            <button type="button" class="btn-agregar-item" (click)="agregarEjemplar()">
              + A√±adir ejemplar
            </button>
          </div>

          <div class="ejemplares-list">
            <div class="ejemplar-item" *ngFor="let ejemplar of ejemplares; let i = index">

              <div class="item-numero">{{ i + 1 }}.</div>

              <div class="item-campos">

                <!-- C√≥digo de Barras -->
                <div class="item-campo">
                  <label>C√≥digo de Barras: *</label>
                  <input type="text" class="item-input" [(ngModel)]="ejemplar.codigo_barra"
                    [name]="'ejemplar_codigo_' + i" placeholder="Ej: LIB-1-001">
                </div>

                <!-- Estanter√≠a -->
                <div class="item-campo">
                  <label>Estanter√≠a:</label>
                  <input type="text" class="item-input" [(ngModel)]="ejemplar.estanteria"
                    [name]="'ejemplar_estanteria_' + i" placeholder="Ej: 014">
                </div>

                <!-- Balda -->
                <div class="item-campo">
                  <label>Balda:</label>
                  <input type="text" class="item-input" [(ngModel)]="ejemplar.balda" [name]="'ejemplar_balda_' + i"
                    placeholder="Ej: 6">
                </div>

                <!-- Estado -->
                <div class="item-campo">
                  <label>Estado:</label>
                  <select class="item-select" [(ngModel)]="ejemplar.estado" [name]="'ejemplar_estado_' + i">
                    <option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
                      {{ estado.texto }}
                    </option>
                  </select>
                </div>

              </div>

              <button type="button" class="btn-eliminar-item" (click)="eliminarEjemplar(i)"
                [disabled]="ejemplares.length === 1" title="Eliminar ejemplar">
                üóëÔ∏è
              </button>

            </div>
          </div>

        </div>

      </form>

      <!-- Mensaje de error -->
      <div class="error-message" *ngIf="error">
        {{ error }}
      </div>

    </div>

    <!-- Footer con botones -->
    <div class="modal-footer">
      <button type="button" class="btn-cancelar" (click)="cerrarModal()" [disabled]="enviando">
        Cancelar
      </button>
      <button type="button" class="btn-guardar" (click)="guardarMaterial()"
        [disabled]="!formularioValido() || enviando">
        {{ enviando ? 'Guardando...' : 'Guardar Material' }}
      </button>
    </div>

  </div>

</div>