<!-- Gestión de Solicitudes PAS -->
<div class="solicitudes">

  <!-- Título principal -->
  <h1 class="page-title">Gestión de Solicitudes</h1>

  <!-- Tabs de filtro por estado -->
  <div class="tabs-container">
    <button class="tab" [class.active]="filtroEstadoActivo === 'todas'" (click)="cambiarFiltroEstado('todas')">
      Todas
    </button>

    <button class="tab" [class.active]="filtroEstadoActivo === 'pendiente'" (click)="cambiarFiltroEstado('pendiente')">
      Pendientes
    </button>

    <button class="tab" [class.active]="filtroEstadoActivo === 'aprobada'" (click)="cambiarFiltroEstado('aprobada')">
      Aprobadas
    </button>

    <button class="tab" [class.active]="filtroEstadoActivo === 'rechazada'" (click)="cambiarFiltroEstado('rechazada')">
      Rechazadas
    </button>
  </div>

  <!-- Barra de búsqueda y filtros -->
  <div class="filters-bar">

    <!-- Barra de búsqueda -->
    <div class="search-box">
      <input type="text" class="search-input" placeholder="Buscar por alumno, material o teléfono..."
        [(ngModel)]="textoBusqueda" (input)="aplicarFiltros()">
    </div>

    <!-- Filtro Tipo de Solicitud -->
    <select class="filter-select" [(ngModel)]="filtroTipo" (change)="aplicarFiltros()">
      <option value="">Tipo de Solicitud</option>
      <option value="prof_trabajo">Tipo A</option>
      <option value="uso_propio">Tipo B</option>
    </select>

    <!-- Filtro Fecha -->
    <select class="filter-select" [(ngModel)]="filtroFecha" (change)="aplicarFiltros()">
      <option value="">Filtro por Fecha</option>
      <option value="hoy">Hoy</option>
      <option value="semana">Esta semana</option>
      <option value="mes">Este mes</option>
    </select>

    <!-- Botón Limpiar Filtros -->
    <button class="btn-limpiar" (click)="limpiarFiltros()" title="Limpiar todos los filtros"
      aria-label="Limpiar todos los filtros">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
        <path d="M3 3v5h5" />
      </svg>
    </button>

  </div>

  <!-- Tabla de solicitudes -->
  <div class="table-container">

    <!-- Header de la tabla -->
    <div class="table-header">
      <div class="th th-alumno sortable" (click)="ordenar('alumno')">
        Alumno
        <span class="sort-icon" [class.active]="sortColumn === 'alumno'">
          {{ sortColumn === 'alumno' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-materiales">Materiales</div>
      <div class="th th-tipo">Tipo</div>
      <div class="th th-fecha sortable" (click)="ordenar('fecha')">
        Fecha Solicitud
        <span class="sort-icon" [class.active]="sortColumn === 'fecha'">
          {{ sortColumn === 'fecha' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-estado">Estado</div>
      <div class="th th-acciones">Acciones</div>
    </div>

    <!-- Body de la tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Cargando solicitudes...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <!-- Sin resultados -->
      <div class="empty-state" *ngIf="!isLoading && !errorMessage && solicitudesFiltradas.length === 0">
        No hay solicitudes para mostrar
      </div>

      <!-- Filas de solicitudes -->
      <div class="table-row" *ngFor="let solicitud of solicitudesFiltradas">

        <!-- Columna: Alumno -->
        <div class="td td-alumno">
          <button class="link-alumno" (click)="abrirPerfilAlumno(solicitud, $event)"
            [attr.aria-label]="'Ver perfil de ' + getNombreUsuario(solicitud)">
            {{ getNombreUsuario(solicitud) }}
          </button>
        </div>
        <!-- Columna: Materiales -->
        <div class="td td-materiales">
          <button class="link-materiales" *ngIf="getItemsSolicitud(solicitud).length > 0"
            (click)="verMaterialesSolicitud(solicitud, $event)" aria-label="Ver materiales de esta solicitud">
            {{ getContadorMateriales(solicitud) }}
          </button>
          <span class="sin-materiales" *ngIf="getItemsSolicitud(solicitud).length === 0">—</span>
        </div>
        <!-- Columna: Tipo -->
        <div class="td td-tipo">
          {{ getTipoTexto(solicitud.tipo) }}
        </div>

        <!-- Columna: Fecha -->
        <div class="td td-fecha">
          {{ formatearFecha(solicitud.creada_en) }}
        </div>

        <!-- Columna: Estado -->
        <div class="td td-estado">
          <span class="badge" [ngClass]="getEstadoClass(solicitud.estado)">
            {{ getEstadoTexto(solicitud.estado) }}
          </span>
        </div>

        <!-- Columna: Acciones -->
        <div class="td td-acciones">
          <ng-container *ngIf="solicitud.estado === 'pendiente'">
            <button class="btn-aprobar" (click)="abrirModalAprobar(solicitud)">
              Aprobar
            </button>

            <button class="btn-rechazar" (click)="abrirModalRechazar(solicitud)">
              Rechazar
            </button>
          </ng-container>

          <span *ngIf="solicitud.estado !== 'pendiente'" class="sin-acciones">
            —
          </span>
        </div>

      </div>

    </div>

  </div>

</div>

<!-- MODAL APROBAR SOLICITUD -->
<div class="modal-overlay" *ngIf="mostrarModalAprobar" (click)="cerrarModalAprobar()" role="dialog" aria-modal="true"
  aria-labelledby="titulo-aprobar">
  <div class="modal-card modal-aprobar-grande" (click)="$event.stopPropagation()">

    <!-- Botón cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalAprobar()" aria-label="Cerrar modal">✕</button>

    <!-- Título -->
    <h2 class="modal-title" id="titulo-aprobar">Aprobar Solicitud</h2>

    <!-- Información de la solicitud -->
    <div class="info-solicitud" *ngIf="solicitudSeleccionada">
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Alumno:</span>
          <span class="info-value">{{ getNombreUsuario(solicitudSeleccionada) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Tipo:</span>
          <span class="info-value">{{ getTipoTexto(solicitudSeleccionada.tipo) }}</span>
        </div>
      </div>
    </div>

    <!-- Materiales solicitados con disponibilidad -->
    <div class="seccion-materiales">
      <h3 class="seccion-titulo">Materiales Solicitados</h3>

      <!-- Loading -->
      <div class="loading-disponibilidad" *ngIf="cargandoDisponibilidad">
        Verificando disponibilidad...
      </div>

      <!-- Lista de items -->
      <div class="materiales-lista" *ngIf="!cargandoDisponibilidad">
        <div class="material-item-disponibilidad" *ngFor="let item of itemsSolicitudConDisponibilidad"
          [class.no-disponible]="!item.disponible" [class.excluido]="!item.incluido">
          <!-- Checkbox para incluir/excluir -->
          <div class="material-checkbox">
            <input type="checkbox" [checked]="item.incluido" [disabled]="!item.disponible"
              (change)="toggleItemIncluido(item)" />
          </div>

          <!-- Info del material -->
          <div class="material-info-completa">
            <div class="material-cabecera">
              <span class="material-tipo-badge" [class.libro]="item.tipo === 'libro'"
                [class.equipo]="item.tipo === 'equipo'">
                {{ item.tipo === 'libro' ? 'Libro' : 'Equipo' }}
              </span>
              <span class="material-nombre">{{ item.nombre }}</span>
            </div>

            <!-- Estado de disponibilidad -->
            <div class="material-disponibilidad-info">
              <span class="material-estado-badge" [class.disponible]="item.disponible"
                [class.no-disponible]="!item.disponible">
                {{ item.disponible ? '✓ Disponible' : '✗ No disponible' }}
              </span>

              <!-- Selector de ejemplar/unidad si hay varios disponibles -->
              <div class="selector-ejemplar"
                *ngIf="item.disponible && item.tipo === 'libro' && item.ejemplares_disponibles.length > 1">
                <label>Ejemplar:</label>
                <select
                  (change)="seleccionarEjemplar(item, $any($event.target).value, $any($event.target).selectedOptions[0].text)">
                  <option *ngFor="let ej of item.ejemplares_disponibles" [value]="ej.id"
                    [selected]="ej.id === item.ejemplar_seleccionado_id">
                    {{ ej.codigo_barra }}
                  </option>
                </select>
              </div>

              <div class="selector-unidad"
                *ngIf="item.disponible && item.tipo === 'equipo' && item.unidades_disponibles.length > 1">
                <label>Unidad:</label>
                <select
                  (change)="seleccionarUnidad(item, $any($event.target).value, $any($event.target).selectedOptions[0].text)">
                  <option *ngFor="let u of item.unidades_disponibles" [value]="u.id"
                    [selected]="u.id === item.unidad_seleccionada_id">
                    {{ u.codigo_barra }}
                  </option>
                </select>
              </div>

              <!-- Mostrar código si solo hay uno -->
              <span class="codigo-seleccionado" *ngIf="item.disponible && item.codigo_barra_seleccionado && 
                ((item.tipo === 'libro' && item.ejemplares_disponibles.length === 1) || 
                 (item.tipo === 'equipo' && item.unidades_disponibles.length === 1))">
                Código: {{ item.codigo_barra_seleccionado }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Materiales adicionales (escaneados por PAS) -->
    <div class="seccion-materiales-adicionales" *ngIf="itemsAdicionales.length > 0">
      <h3 class="seccion-titulo">Materiales Adicionales (añadidos por PAS)</h3>
      <div class="materiales-lista">
        <div class="material-item adicional" *ngFor="let item of itemsAdicionales; let i = index">
          <span class="material-tipo-badge" [class.libro]="item.tipo === 'ejemplar'"
            [class.equipo]="item.tipo === 'unidad'">
            {{ item.tipo === 'ejemplar' ? 'Libro' : 'Equipo' }}
          </span>
          <div class="material-info-adicional">
            <span class="material-nombre">{{ item.nombre }}</span>
            <span class="material-codigo-small">{{ item.codigo_barra }}</span>
          </div>
          <button class="btn-eliminar-item" (click)="eliminarItemAdicional(i)">✕</button>
        </div>
      </div>
    </div>

    <!-- Botón para añadir materiales -->
    <div class="seccion-añadir">
      <button class="btn-añadir-material" (click)="toggleBuscadorMateriales()">
        {{ mostrarBuscadorMateriales ? '− Cerrar escáner' : '+ Añadir material (escanear código)' }}
      </button>
    </div>

    <!-- Buscador por código de barras -->
    <div class="buscador-materiales" *ngIf="mostrarBuscadorMateriales">
      <div class="buscador-input-group">
        <input type="text" class="buscador-input" placeholder="Escanea o introduce el código de barras..."
          [(ngModel)]="codigoBarrasBusqueda" (keyup.enter)="buscarPorCodigoBarras()" />
        <button class="btn-buscar-material" (click)="buscarPorCodigoBarras()" [disabled]="buscandoMaterial">
          {{ buscandoMaterial ? 'Buscando...' : 'Buscar' }}
        </button>
      </div>

      <div class="buscador-error" *ngIf="errorBusqueda">
        {{ errorBusqueda }}
      </div>

      <div class="material-encontrado" *ngIf="materialEncontrado">
        <div class="material-encontrado-info">
          <span class="material-tipo-badge" [class.libro]="materialEncontrado.tipo === 'ejemplar'"
            [class.equipo]="materialEncontrado.tipo === 'unidad'">
            {{ materialEncontrado.tipo === 'ejemplar' ? 'Libro' : 'Equipo' }}
          </span>
          <div class="material-encontrado-detalle">
            <span class="material-nombre">
              {{ materialEncontrado.tipo === 'ejemplar' ? materialEncontrado.libro?.titulo :
              materialEncontrado.equipo?.nombre }}
            </span>
            <span class="material-codigo">Código: {{ materialEncontrado.codigo_barra }}</span>
          </div>
          <span class="material-estado" [class.disponible]="materialEncontrado.disponible"
            [class.no-disponible]="!materialEncontrado.disponible">
            {{ materialEncontrado.disponible ? '✓ Disponible' : '✗ No disponible' }}
          </span>
        </div>
        <button class="btn-agregar-material" (click)="agregarMaterialEncontrado()"
          [disabled]="!materialEncontrado.disponible">
          Añadir
        </button>
      </div>
    </div>

    <!-- Campo fecha de devolución (solo para Tipo A) -->
    <div class="campo-fecha" *ngIf="solicitudSeleccionada?.tipo === 'prof_trabajo'">
      <label class="campo-label">
        Fecha de devolución <span class="required">*</span>
      </label>
      <input type="date" class="campo-input" [(ngModel)]="fechaDevolucion" [min]="fechaMinDevolucion" />
      <p class="campo-ayuda">Establece la fecha en la que el alumno debe devolver el material</p>
    </div>

    <!-- Selector de idioma para email -->
    <div class="form-group">
      <label class="form-label">
        Idioma del email
      </label>
      <div class="idioma-selector-compact">
        <label class="idioma-option-compact" [class.selected]="idiomaEmailAprobacion === 'es'">
          <input type="radio" name="idiomaAprobacion" value="es" [(ngModel)]="idiomaEmailAprobacion" />
          <span>ES</span>
        </label>

        <label class="idioma-option-compact" [class.selected]="idiomaEmailAprobacion === 'en'">
          <input type="radio" name="idiomaAprobacion" value="en" [(ngModel)]="idiomaEmailAprobacion" />
          <span>EN</span>
        </label>
      </div>
    </div>

    <!-- Botones -->
    <div class="modal-actions">
      <button class="btn-cancelar" (click)="cerrarModalAprobar()">
        Cancelar
      </button>
      <button class="btn-confirmar success" (click)="confirmarAprobacion()" [disabled]="aprobandoSolicitud">
        {{ aprobandoSolicitud ? 'Aprobando...' : 'Aprobar Solicitud' }}
      </button>
    </div>

  </div>
</div>

<!-- MODAL RECHAZAR SOLICITUD -->
<div class="modal-overlay" *ngIf="mostrarModalRechazar" (click)="cerrarModalRechazar()" role="dialog" aria-modal="true"
  aria-labelledby="titulo-rechazar">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <button class="btn-cerrar" (click)="cerrarModalRechazar()" aria-label="Cerrar modal">✕</button>

    <h2 class="modal-title" id="titulo-rechazar">Rechazar Solicitud</h2>

    <div class="info-solicitud" *ngIf="solicitudSeleccionada">
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Alumno:</span>
          <span class="info-value">{{ getNombreUsuario(solicitudSeleccionada) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Tipo:</span>
          <span class="info-value">{{ getTipoTexto(solicitudSeleccionada.tipo) }}</span>
        </div>
      </div>
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Material:</span>
          <span class="info-value">{{ getNombreMaterial(solicitudSeleccionada) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Fecha Solicitud:</span>
          <span class="info-value">{{ formatearFecha(solicitudSeleccionada.creada_en) }}</span>
        </div>
      </div>
    </div>

    <div class="campo-idioma">
      <label class="campo-label">Idioma del email</label>
      <div class="idioma-selector-compact">
        <label class="idioma-option-compact" [class.selected]="idiomaEmailRechazo === 'es'">
          <input type="radio" name="idiomaRechazo" value="es" [(ngModel)]="idiomaEmailRechazo" />
          <span>ES</span>
        </label>
        <label class="idioma-option-compact" [class.selected]="idiomaEmailRechazo === 'en'">
          <input type="radio" name="idiomaRechazo" value="en" [(ngModel)]="idiomaEmailRechazo" />
          <span>EN</span>
        </label>
      </div>
    </div>

    <div class="campo-motivo">
      <label class="campo-label">
        Plantilla de rechazo <span class="required">*</span>
      </label>
      <div class="loading-motivos" *ngIf="cargandoMotivos">
        Cargando plantillas...
      </div>
      <select class="campo-select" [(ngModel)]="motivoSeleccionado" *ngIf="!cargandoMotivos">
        <option [ngValue]="null">Selecciona un motivo</option>
        <option *ngFor="let motivo of motivosRechazo" [ngValue]="motivo">
          {{ idiomaEmailRechazo === 'en' ? motivo.titulo_en : motivo.titulo_es }}
        </option>
      </select>
    </div>

    <div class="preview-email" *ngIf="motivoSeleccionado">
      <label class="campo-label">Vista previa del email</label>
      <div class="preview-contenido">
        <div class="preview-asunto">
          <strong>Asunto:</strong> {{ obtenerTituloEmailRechazo() }}
        </div>
        <div class="preview-cuerpo">
          {{ obtenerPreviewEmailRechazo() }}
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancelar" (click)="cerrarModalRechazar()">
        Cancelar
      </button>
      <button class="btn-confirmar danger" (click)="confirmarRechazo()"
        [disabled]="!motivoSeleccionado || rechazandoSolicitud">
        {{ rechazandoSolicitud ? 'Rechazando...' : 'Confirmar Rechazo' }}
      </button>
    </div>

  </div>
</div>

<!-- MODAL DETALLES DE MATERIALES -->
<div class="modal-overlay" *ngIf="mostrarModalDetallesMateriales" (click)="cerrarModalDetallesMateriales()"
  role="dialog" aria-modal="true" aria-labelledby="titulo-detalles-mat">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Botón cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalDetallesMateriales()" aria-label="Cerrar modal">✕</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title" id="titulo-detalles-mat">Materiales de la Solicitud</h2>
    </div>

    <!-- Info del alumno -->
    <div class="modal-alumno" *ngIf="solicitudDetallesMateriales">
      <span class="alumno-label">Alumno:</span>
      <span class="alumno-nombre">{{ getNombreUsuario(solicitudDetallesMateriales) }}</span>
    </div>

    <!-- Lista de materiales -->
    <div class="materiales-lista">
      <div class="material-item" *ngFor="let item of materialesDetalles; let i = index">
        <div class="material-numero">{{ i + 1 }}</div>
        <div class="material-info">
          <div class="material-nombre">{{ getNombreItem(item) }}</div>
          <div class="material-detalles">
            <span class="material-tipo">{{ getTipoItem(item) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalDetallesMateriales()">Cerrar</button>
    </div>

  </div>
</div>

<!-- MODAL PERFIL USUARIO -->
<div class="modal-overlay" *ngIf="mostrarModalPerfil" (click)="cerrarModalPerfil()" role="dialog" aria-modal="true"
  aria-labelledby="titulo-perfil-sol">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Botón cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalPerfil()" aria-label="Cerrar modal">✕</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title" id="titulo-perfil-sol">Perfil del Alumno</h2>
    </div>

    <!-- Info del usuario -->
    <div class="perfil-contenido" *ngIf="usuarioPerfilSeleccionado">

      <!-- Card: Información Personal -->
      <div class="perfil-card">
        <div class="perfil-card-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>Información Personal</span>
        </div>
        <div class="perfil-card-body">
          <div class="perfil-field">
            <span class="perfil-label">Nombre completo</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.nombre }} {{ usuarioPerfilSeleccionado.apellidos
              }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Email</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.email }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Teléfono</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.telefono || 'No especificado' }}</span>
          </div>
        </div>
      </div>

      <!-- Card: Datos Académicos -->
      <div class="perfil-card">
        <div class="perfil-card-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
            <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
          </svg>
          <span>Datos Académicos</span>
        </div>
        <div class="perfil-card-body">
          <div class="perfil-field">
            <span class="perfil-label">Código de tarjeta</span>
            <span class="perfil-value perfil-codigo">{{ usuarioPerfilSeleccionado.codigo_tarjeta || 'Sin asignar'
              }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Estado del perfil</span>
            <span class="perfil-badge" [class.activo]="usuarioPerfilSeleccionado.estado_perfil === 'activo'"
              [class.bloqueado]="usuarioPerfilSeleccionado.estado_perfil === 'bloqueado'"
              [class.inactivo]="usuarioPerfilSeleccionado.estado_perfil === 'inactivo'">
              {{ usuarioPerfilSeleccionado.estado_perfil || 'Desconocido' }}
            </span>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalPerfil()">Cerrar</button>
    </div>

  </div>
</div>

<!-- MODAL DE NOTIFICACIONES -->
<app-modal [mostrar]="mostrarModalNotificacion" [tipo]="tipoModalNotificacion" [titulo]="tituloModalNotificacion"
  [mensaje]="mensajeModalNotificacion" [textoBtnPrincipal]="'Aceptar'" (cerrar)="cerrarModalNotificacion()"></app-modal>