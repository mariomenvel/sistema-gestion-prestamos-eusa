<!-- GestiÃ³n de Solicitudes PAS -->
<div class="solicitudes">

  <!-- TÃ­tulo principal -->
  <h1 class="page-title">GestiÃ³n de Solicitudes</h1>

  <!-- Tabs de filtro por estado -->
  <div class="tabs-container">
    <button 
      class="tab"
      [class.active]="filtroEstadoActivo === 'todas'"
      (click)="cambiarFiltroEstado('todas')"
    >
      Todas
    </button>
    
    <button 
      class="tab"
      [class.active]="filtroEstadoActivo === 'pendiente'"
      (click)="cambiarFiltroEstado('pendiente')"
    >
      Pendientes
    </button>
    
    <button 
      class="tab"
      [class.active]="filtroEstadoActivo === 'aprobada'"
      (click)="cambiarFiltroEstado('aprobada')"
    >
      Aprobadas
    </button>
    
    <button 
      class="tab"
      [class.active]="filtroEstadoActivo === 'rechazada'"
      (click)="cambiarFiltroEstado('rechazada')"
    >
      Rechazadas
    </button>
  </div>

  <!-- Barra de bÃºsqueda y filtros -->
  <div class="filters-bar">
    
    <!-- Barra de bÃºsqueda -->
    <div class="search-box">
      <input 
        type="text" 
        class="search-input"
        placeholder="Buscar por alumno, material..."
        [(ngModel)]="textoBusqueda"
        (input)="buscar()"
      >
    </div>

    <!-- Filtro Tipo de Solicitud -->
    <select class="filter-select" [(ngModel)]="filtroTipo" (change)="buscar()">
      <option value="">Tipo de Solicitud</option>
      <option value="prof_trabajo">Tipo A</option>
      <option value="uso_propio">Tipo B</option>
    </select>

    <!-- Filtro Fecha -->
    <select class="filter-select" [(ngModel)]="filtroFecha" (change)="buscar()">
      <option value="">Filtro por Fecha</option>
      <option value="hoy">Hoy</option>
      <option value="semana">Esta semana</option>
      <option value="mes">Este mes</option>
    </select>

    <!-- BotÃ³n Limpiar Filtros -->
    <button class="btn-limpiar" (click)="limpiarFiltros()">
      Limpiar Filtros
    </button>

  </div>

  <!-- Tabla de solicitudes -->
  <div class="table-container">
    
    <!-- Header de la tabla -->
    <div class="table-header">
      <div class="th th-alumno">Alumno</div>
      <div class="th th-materiales">Materiales</div>
      <div class="th th-tipo">Tipo</div>
      <div class="th th-fecha">Fecha Solicitud</div>
      <div class="th th-estado">Estado</div>
      <div class="th th-acciones">Acciones</div>
    </div>

    <!-- Body de la tabla -->
    <div class="table-body">
      
      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        Cargando solicitudes...
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <!-- Sin resultados -->
      <div class="empty-state" *ngIf="!isLoading && !errorMessage && solicitudesFiltradas.length === 0">
        No hay solicitudes para mostrar
      </div>

      <!-- Filas de solicitudes -->
      <div 
        class="table-row"
        *ngFor="let solicitud of solicitudesFiltradas"
      >
        
        <!-- Columna: Alumno -->
        <div class="td td-alumno">
          {{ getNombreUsuario(solicitud) }}
        </div>

        <!-- Columna: Materiales -->
        <div class="td td-materiales">
          {{ getContadorMateriales(solicitud) }}
        </div>

        <!-- Columna: Tipo -->
        <div class="td td-tipo">
          {{ getTipoTexto(solicitud.tipo) }}
        </div>

        <!-- Columna: Fecha -->
        <div class="td td-fecha">
          {{ formatearFecha(solicitud.creada_en) }}
        </div>

        <!-- Columna: Estado -->
        <div class="td td-estado">
          <span 
            class="badge"
            [ngClass]="getEstadoClass(solicitud.estado)"
          >
            {{ getEstadoTexto(solicitud.estado) }}
          </span>
        </div>

        <!-- Columna: Acciones -->
        <div class="td td-acciones">
          <ng-container *ngIf="solicitud.estado === 'pendiente'">
            <button 
              class="btn-aprobar"
              (click)="abrirModalAprobar(solicitud)"
            >
              Aprobar
            </button>
            
            <button 
              class="btn-rechazar"
              (click)="abrirModalRechazar(solicitud)"
            >
              Rechazar
            </button>
          </ng-container>
          
          <span *ngIf="solicitud.estado !== 'pendiente'" class="sin-acciones">
            â€”
          </span>
        </div>

      </div>

    </div>

  </div>

</div>

<!-- MODAL APROBAR SOLICITUD -->
<div class="modal-overlay" *ngIf="mostrarModalAprobar" (click)="cerrarModalAprobar()">
  <div class="modal-card modal-aprobar-grande" (click)="$event.stopPropagation()">
    
    <!-- BotÃ³n cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalAprobar()">âœ•</button>

    <!-- TÃ­tulo -->
    <h2 class="modal-title">Aprobar Solicitud</h2>

    <!-- InformaciÃ³n de la solicitud -->
    <div class="info-solicitud" *ngIf="solicitudSeleccionada">
      
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Alumno:</span>
          <span class="info-value">{{ getNombreUsuario(solicitudSeleccionada) }}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Tipo:</span>
          <span class="info-value">{{ getTipoTexto(solicitudSeleccionada.tipo) }}</span>
        </div>
      </div>

    </div>

    <!-- Materiales solicitados -->
    <div class="seccion-materiales">
      <h3 class="seccion-titulo">Materiales Solicitados</h3>
      <div class="materiales-lista">
        <div class="material-item" *ngFor="let item of getItemsSolicitud(solicitudSeleccionada!)">
          <span class="material-tipo-badge">{{ getTipoItem(item) }}</span>
          <span class="material-nombre">{{ getNombreItem(item) }}</span>
        </div>
      </div>
    </div>

    <!-- Materiales adicionales -->
    <div class="seccion-materiales-adicionales" *ngIf="itemsAdicionales.length > 0">
      <h3 class="seccion-titulo">Materiales Adicionales (aÃ±adidos por PAS)</h3>
      <div class="materiales-lista">
        <div class="material-item adicional" *ngFor="let item of itemsAdicionales; let i = index">
          <span class="material-tipo-badge" [class.libro]="item.tipo === 'libro'" [class.equipo]="item.tipo === 'equipo'">
            {{ item.tipo === 'libro' ? 'Libro' : 'Equipo' }}
          </span>
          <span class="material-nombre">{{ item.nombre }}</span>
          <button class="btn-eliminar-item" (click)="eliminarItemAdicional(i)">âœ•</button>
        </div>
      </div>
    </div>

    <!-- BotÃ³n para aÃ±adir materiales -->
    <div class="seccion-aÃ±adir">
      <button 
        class="btn-aÃ±adir-material" 
        (click)="toggleBuscadorMateriales()"
      >
        {{ mostrarBuscadorMateriales ? 'âˆ’ Cerrar buscador' : '+ AÃ±adir material adicional' }}
      </button>
    </div>

    <!-- Buscador de materiales -->
    <div class="buscador-materiales" *ngIf="mostrarBuscadorMateriales">
      
      <!-- Tabs libro/equipo -->
      <div class="buscador-tabs">
        <button 
          class="buscador-tab" 
          [class.active]="tipoBusqueda === 'libro'"
          (click)="cambiarTipoBusqueda('libro')"
        >
          ðŸ“š Libros
        </button>
        <button 
          class="buscador-tab" 
          [class.active]="tipoBusqueda === 'equipo'"
          (click)="cambiarTipoBusqueda('equipo')"
        >
          ðŸ“· Equipos
        </button>
      </div>

      <!-- Input de bÃºsqueda -->
      <div class="buscador-input-group">
        <input 
          type="text" 
          class="buscador-input"
          [placeholder]="tipoBusqueda === 'libro' ? 'Buscar por tÃ­tulo o autor...' : 'Buscar por marca o modelo...'"
          [(ngModel)]="textoBusquedaMaterial"
          (keyup.enter)="buscarMateriales()"
        />
        <button 
          class="btn-buscar-material"
          (click)="buscarMateriales()"
          [disabled]="buscandoMateriales"
        >
          {{ buscandoMateriales ? 'Buscando...' : 'Buscar' }}
        </button>
      </div>

      <!-- Resultados de libros -->
      <div class="buscador-resultados" *ngIf="tipoBusqueda === 'libro' && librosDisponibles.length > 0">
        <div 
          class="resultado-item" 
          *ngFor="let libro of librosDisponibles"
          (click)="agregarLibro(libro)"
        >
          <div class="resultado-info">
            <span class="resultado-nombre">{{ libro.titulo }}</span>
            <span class="resultado-detalle">{{ libro.autor }}</span>
          </div>
          <span class="resultado-disponibles">{{ libro.disponibles }} disp.</span>
        </div>
      </div>

      <!-- Resultados de equipos -->
      <div class="buscador-resultados" *ngIf="tipoBusqueda === 'equipo' && equiposDisponibles.length > 0">
        <div 
          class="resultado-item" 
          *ngFor="let equipo of equiposDisponibles"
          (click)="agregarEquipo(equipo)"
        >
          <div class="resultado-info">
            <span class="resultado-nombre">{{ equipo.nombre }}</span>
            <span class="resultado-detalle">{{ equipo.marca }}</span>
          </div>
          <span class="resultado-disponibles">{{ equipo.disponibles }} disp.</span>
        </div>
      </div>

      <!-- Sin resultados -->
      <div class="buscador-vacio" *ngIf="(tipoBusqueda === 'libro' && librosDisponibles.length === 0 && textoBusquedaMaterial) || (tipoBusqueda === 'equipo' && equiposDisponibles.length === 0 && textoBusquedaMaterial)">
        No se encontraron {{ tipoBusqueda === 'libro' ? 'libros' : 'equipos' }} disponibles
      </div>

    </div>

    <!-- Campo fecha de devoluciÃ³n (solo para Tipo A) -->
    <div class="campo-fecha" *ngIf="solicitudSeleccionada?.tipo === 'prof_trabajo'">
      <label class="campo-label">
        Fecha de devoluciÃ³n <span class="required">*</span>
      </label>
      <input 
        type="date" 
        class="campo-input"
        [(ngModel)]="fechaDevolucion"
      />
      <p class="campo-ayuda">Establece la fecha en la que el alumno debe devolver el material</p>
    </div>

    <!-- Botones -->
    <div class="modal-actions">
      <button class="btn-cancelar" (click)="cerrarModalAprobar()">
        Cancelar
      </button>
      <button class="btn-confirmar success" (click)="confirmarAprobacion()">
        Confirmar AprobaciÃ³n
      </button>
    </div>

  </div>
</div>

<!-- MODAL RECHAZAR SOLICITUD -->
<div class="modal-overlay" *ngIf="mostrarModalRechazar" (click)="cerrarModalRechazar()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    
    <!-- BotÃ³n cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalRechazar()">âœ•</button>

    <!-- TÃ­tulo -->
    <h2 class="modal-title">Rechazar Solicitud</h2>

    <!-- InformaciÃ³n de la solicitud -->
    <div class="info-solicitud" *ngIf="solicitudSeleccionada">
      
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Alumno:</span>
          <span class="info-value">{{ getNombreUsuario(solicitudSeleccionada) }}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Tipo:</span>
          <span class="info-value">{{ getTipoTexto(solicitudSeleccionada.tipo) }}</span>
        </div>
      </div>

      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Material:</span>
          <span class="info-value">{{ getNombreMaterial(solicitudSeleccionada) }}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">Fecha Solicitud:</span>
          <span class="info-value">{{ formatearFecha(solicitudSeleccionada.creada_en) }}</span>
        </div>
      </div>

    </div>

    <!-- Campo motivo de rechazo -->
    <div class="campo-motivo">
      <label class="campo-label">
        Motivo de rechazo <span class="required">*</span>
      </label>
      <textarea 
        class="campo-textarea"
        rows="3"
        placeholder="Ej: Material no disponible, solicitud duplicada, datos incorrectos..."
        [(ngModel)]="motivoRechazo"
      ></textarea>
    </div>

    <!-- Botones -->
    <div class="modal-actions">
      <button class="btn-cancelar" (click)="cerrarModalRechazar()">
        Cancelar
      </button>
      <button class="btn-confirmar danger" (click)="confirmarRechazo()">
        Confirmar Rechazo
      </button>
    </div>

  </div>
</div>

<!-- MODAL DE NOTIFICACIONES -->
<app-modal
  [mostrar]="mostrarModalNotificacion"
  [tipo]="tipoModalNotificacion"
  [titulo]="tituloModalNotificacion"
  [mensaje]="mensajeModalNotificacion"
  [textoBtnPrincipal]="'Aceptar'"
  (cerrar)="cerrarModalNotificacion()"
></app-modal>