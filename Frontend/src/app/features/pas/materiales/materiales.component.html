<!-- Gesti√≥n de Materiales PAS -->
<div class="materiales">

  <!-- Header con t√≠tulo y bot√≥n -->
  <div class="header">
    <h1 class="page-title">Gesti√≥n de Materiales</h1>
    <button class="btn-anadir" (click)="abrirModalAnadirMaterial()">
      A√±adir Material
    </button>
  </div>

  <div class="filtros-container">
    <div class="filtros-basicos">
      <div class="tipo-toggle">
        <button class="btn-tipo" [class.activo]="tipoSeleccionado === 'libros'" (click)="setTipo('libros')">
          <i class="fas fa-book"></i> Libros
        </button>
        <button class="btn-tipo" [class.activo]="tipoSeleccionado === 'equipos'" (click)="setTipo('equipos')">
          <i class="fas fa-laptop"></i> Equipos
        </button>
      </div>

      <div class="busqueda">
        <input type="text" class="input-busqueda" [(ngModel)]="busqueda" (input)="aplicarFiltros()"
          [placeholder]="tipoSeleccionado === 'libros' ? 'Buscar por t√≠tulo, autor o ISBN...' : 'Buscar por marca, modelo o descripci√≥n...'">
      </div>

      <div class="filtro">
        <select class="select-filtro" [(ngModel)]="filtroCategoria" (change)="aplicarFiltros()">
          <option value="">Todas las categor√≠as</option>
          <option *ngFor="let cat of categorias" [value]="cat.id">
            {{ cat.nombre }}
          </option>
        </select>
      </div>

      <div class="filtro" *ngIf="tipoSeleccionado === 'equipos'">
        <select class="select-filtro" [(ngModel)]="filtroNombre" (change)="aplicarFiltros()">
          <option value="">Todos los nombres</option>
          <option *ngFor="let n of getNombresDisponibles()" [value]="n.id">
            {{ n.nombre }}
          </option>
        </select>
      </div>

      <button class="btn-reset" (click)="limpiarFiltros()" title="Limpiar todos los filtros">
        Limpiar
      </button>
    </div>

    <!-- FILTROS AVANZADOS (Rangos de disponibilidad) -->
    <div class="filtros-avanzados">
      <div class="rango-filtro">
        <label>Disponibles:</label>
        <div class="inputs-rango">
          <input type="number" class="input-mini" [(ngModel)]="minDisponibles" (input)="aplicarFiltros()"
            placeholder="M√≠n">
          <span>-</span>
          <input type="number" class="input-mini" [(ngModel)]="maxDisponibles" (input)="aplicarFiltros()"
            placeholder="M√°x">
        </div>
      </div>

      <div class="rango-filtro">
        <label>Totales:</label>
        <div class="inputs-rango">
          <input type="number" class="input-mini" [(ngModel)]="minTotales" (input)="aplicarFiltros()" placeholder="M√≠n">
          <span>-</span>
          <input type="number" class="input-mini" [(ngModel)]="maxTotales" (input)="aplicarFiltros()" placeholder="M√°x">
        </div>
      </div>
    </div>

  </div>

  <!-- Tabla de materiales -->
  <div class="table-container">

    <!-- Header tabla -->
    <div class="table-header" [ngClass]="tipoSeleccionado === 'equipos' ? 'header-equipos' : 'header-libros'">
      <!-- Encabezados para EQUIPOS -->
      <ng-container *ngIf="tipoSeleccionado === 'equipos'">
        <div class="th">Foto</div>
        <div class="th sortable" (click)="toggleSort('categoria')">
          Categor√≠a
          <span class="sort-icon" *ngIf="sortColumn === 'categoria'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th sortable" (click)="toggleSort('nombre')">
          Nombre
          <span class="sort-icon" *ngIf="sortColumn === 'nombre'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th sortable" (click)="toggleSort('marca')">
          Marca
          <span class="sort-icon" *ngIf="sortColumn === 'marca'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th sortable" (click)="toggleSort('modelo')">
          Modelo
          <span class="sort-icon" *ngIf="sortColumn === 'modelo'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th">Descripci√≥n</div>
        <div class="th th-centrado sortable" (click)="toggleSort('disp')">
          Disp.
          <span class="sort-icon" *ngIf="sortColumn === 'disp'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-centrado sortable" (click)="toggleSort('total')">
          Total
          <span class="sort-icon" *ngIf="sortColumn === 'total'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th">Acciones</div>
      </ng-container>

      <!-- Encabezados para LIBROS -->
      <ng-container *ngIf="tipoSeleccionado === 'libros'">
        <div class="th th-foto sortable" (click)="toggleSort('codigo')">
          Portada
          <span class="sort-icon" *ngIf="sortColumn === 'codigo'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-categoria sortable" (click)="toggleSort('categoria')">
          Categor√≠a
          <span class="sort-icon" *ngIf="sortColumn === 'categoria'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-titulo sortable" (click)="toggleSort('nombre')">
          T√≠tulo
          <span class="sort-icon" *ngIf="sortColumn === 'nombre'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-autor sortable" (click)="toggleSort('autor')">
          Autor
          <span class="sort-icon" *ngIf="sortColumn === 'autor'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-editorial sortable" (click)="toggleSort('editorial')">
          Editorial
          <span class="sort-icon" *ngIf="sortColumn === 'editorial'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-centrado sortable" (click)="toggleSort('disp')">
          Disp.
          <span class="sort-icon" *ngIf="sortColumn === 'disp'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-centrado sortable" (click)="toggleSort('total')">
          Total
          <span class="sort-icon" *ngIf="sortColumn === 'total'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-acciones">Acciones</div>
      </ng-container>
    </div>

    <!-- Body tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <p>Cargando materiales...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin materiales (Equipos) -->
      <div class="empty-state"
        *ngIf="!isLoading && !errorMessage && tipoSeleccionado === 'equipos' && materialesFiltrados.length === 0">
        <p>No hay equipos disponibles</p>
      </div>

      <!-- Sin materiales (Libros) -->
      <div class="empty-state"
        *ngIf="!isLoading && !errorMessage && tipoSeleccionado === 'libros' && materialesFiltrados.length === 0">
        <p>No hay libros disponibles</p>
      </div>

      <!-- FILAS DE EQUIPOS -->
      <ng-container *ngIf="tipoSeleccionado === 'equipos'">
        <div class="table-body">
          <ng-container *ngFor="let m of materialesFiltrados">
            <!-- FILA DE EQUIPO -->
            <ng-container *ngIf="'unidades' in m">
              <div class="table-row row-equipos" [class.expanded]="isFilaExpandida(m.id)">
                <!-- Foto -->
                <div class="td td-foto">
                  <img *ngIf="$any(m).foto_url" [src]="$any(m).foto_url" alt="Foto material" class="thumb-material">
                  <div *ngIf="!$any(m).foto_url" class="thumb-placeholder">üì∑</div>
                </div>

                <!-- Categor√≠a -->
                <div class="td td-categoria">
                  {{ m.categoria?.nombre || 'Sin cat.' }}
                </div>

                <!-- Nombre -->
                <div class="td td-nombre clickable" (click)="toggleFila(m.id)">
                  {{ $any(m).Nombre?.nombre || 'Sin nombre' }}
                </div>

                <!-- Marca -->
                <div class="td td-marca">
                  {{ $any(m).marca }}
                </div>

                <!-- Modelo -->
                <div class="td td-modelo">
                  {{ $any(m).modelo }}
                </div>

                <!-- Descripci√≥n -->
                <div class="td td-descripcion" [title]="$any(m).descripcion">
                  {{ $any(m).descripcion || '---' }}
                </div>

                <!-- Disponibles -->
                <div class="td td-count-disp">
                  <span class="count-pill disp">{{ getUnidadesDisponiblesCount($any(m)) }}</span>
                </div>

                <!-- Totales -->
                <div class="td td-count-total">
                  <span class="count-pill total">{{ $any(m).unidades?.length || 0 }}</span>
                </div>

                <!-- Acciones -->
                <div class="td td-acciones">
                  <button class="btn-editar" (click)="editarEquipo($any(m))" title="Editar equipo"></button>
                  <button class="btn-eliminar" (click)="eliminarMaterial(m, 'equipo')" title="Eliminar equipo">
                    üóëÔ∏è
                  </button>
                </div>
              </div>

              <!-- SUBTABLA DE UNIDADES (desplegable simplificado) -->
              <div class="subtable-container-simple" *ngIf="isFilaExpandida(m.id)">

                <!-- MODO EDICI√ìN -->
                <div class="equipo-edicion" *ngIf="isEquipoEnEdicion($any(m))">

                  <h3 class="edicion-titulo">Editar Equipo</h3>

                  <div class="edicion-grid">

                    <!-- Columna Izquierda: Imagen -->
                    <div class="edicion-imagen-seccion">
                      <label class="edicion-label">Imagen del equipo</label>

                      <div class="imagen-upload">
                        <img *ngIf="equipoEnEdicion!.foto_url" [src]="equipoEnEdicion!.foto_url"
                          [alt]="equipoEnEdicion!.marca + ' ' + equipoEnEdicion!.modelo">
                        <div *ngIf="!equipoEnEdicion!.foto_url" class="imagen-placeholder">
                          üì∑
                        </div>
                      </div>

                      <input type="file" id="inputImagen" accept="image/*"
                        (change)="onArchivoImagenSeleccionado($event)" style="display: none;">

                      <label for="inputImagen" class="btn-seleccionar-imagen">
                        Seleccionar imagen
                      </label>

                      <p class="imagen-info">Formatos: JPG, PNG, SVG</p>
                    </div>

                    <!-- Columna Derecha: Formulario -->
                    <div class="edicion-form-seccion">

                      <!-- Marca -->
                      <div class="form-field">
                        <label class="edicion-label">Marca *</label>
                        <input type="text" class="input-edicion" [(ngModel)]="equipoEnEdicion!.marca"
                          placeholder="Ej: Canon">
                      </div>

                      <!-- Modelo -->
                      <div class="form-field">
                        <label class="edicion-label">Modelo *</label>
                        <input type="text" class="input-edicion" [(ngModel)]="equipoEnEdicion!.modelo"
                          placeholder="Ej: EOS 250D">
                      </div>

                      <!-- Categor√≠a -->
                      <div class="form-field">
                        <label class="edicion-label">Categor√≠a *</label>
                        <select class="select-edicion" [(ngModel)]="equipoEnEdicion!.categoria_codigo">
                          <option *ngFor="let catCodigo of getCategoriasDisponibles()" [value]="catCodigo">
                            {{ getNombreCategoriaPorCodigo(catCodigo) }}
                          </option>
                        </select>
                      </div>

                      <!-- Descripci√≥n -->
                      <div class="form-field">
                        <label class="edicion-label">Descripci√≥n</label>
                        <textarea class="textarea-edicion" [(ngModel)]="equipoEnEdicion!.descripcion"
                          placeholder="Descripci√≥n opcional del equipo" rows="3"></textarea>
                      </div>

                    </div>

                  </div>

                  <!-- Botones de acci√≥n -->
                  <div class="edicion-botones">
                    <button class="btn-cancelar-edicion" (click)="cancelarEdicion()">
                      Cancelar
                    </button>
                    <button class="btn-guardar-edicion" (click)="guardarEquipo()">
                      Guardar Cambios
                    </button>
                  </div>

                </div>

                <!-- MODO VISTA (normal) -->
                <div class="equipo-detalle" *ngIf="!isEquipoEnEdicion($any(m))">
                  <div class="equipo-imagen">
                    <img *ngIf="$any(m).foto_url" [src]="$any(m).foto_url" [alt]="$any(m).marca + ' ' + $any(m).modelo">
                    <div *ngIf="!$any(m).foto_url" class="imagen-placeholder">
                    </div>
                  </div>

                  <div class="equipo-info">
                    <h4>{{ $any(m).marca }} {{ $any(m).modelo }}</h4>
                    <p><strong>Categor√≠a:</strong> {{ getNombreCategoria(m) }}</p>
                    <p *ngIf="$any(m).descripcion"><strong>Descripci√≥n:</strong> {{ $any(m).descripcion }}</p>
                  </div>
                </div>

                <!-- Separador -->
                <div class="subtable-divider"></div>

                <!-- Lista simple de unidades -->
                <div class="unidades-list">

                  <!-- Fila de unidad simple -->
                  <div class="unidad-row" *ngFor="let unidad of $any(m).unidades; let i = index">

                    <div class="unidad-numero">{{ i + 1 }}.</div>

                    <!-- N√∫mero de Serie (editable) -->
                    <div class="unidad-campo">
                      <label>N¬∞ Serie:</label>
                      <input type="text" class="input-simple" [(ngModel)]="unidad.numero_serie"
                        placeholder="Sin n√∫mero de serie" (blur)="guardarCambiosUnidad(unidad)"
                        [disabled]="isEquipoEnEdicion($any(m))">
                    </div>

                    <!-- C√≥digo de Barras (editable) -->
                    <div class="unidad-campo">
                      <label>C√≥digo:</label>
                      <input type="text" class="input-simple" [(ngModel)]="unidad.codigo_barra"
                        (blur)="guardarCambiosUnidad(unidad)" [disabled]="isEquipoEnEdicion($any(m))">
                    </div>

                    <!-- Estado Pr√©stamo (Badge) -->
                    <div class="unidad-campo">
                      <label>Pr√©stamo:</label>
                      <span class="badge" [ngClass]="getPrestadoBadgeClass(unidad.esta_prestado)">
                        {{ getPrestadoTexto(unidad.esta_prestado) }}
                      </span>
                    </div>

                    <!-- Estado F√≠sico (Select con Badge context) -->
                    <div class="unidad-campo">
                      <label>Estado F√≠sico:</label>
                      <select class="select-simple" [(ngModel)]="unidad.estado_fisico"
                        (change)="guardarCambiosUnidad(unidad)" [disabled]="isEquipoEnEdicion($any(m))"
                        [ngClass]="getFisicoBadgeClass(unidad.estado_fisico)">
                        <option value="funciona">Funcional</option>
                        <option value="en_reparacion">En reparaci√≥n</option>
                        <option value="no_funciona">No funciona</option>
                        <option value="falla">Con fallos</option>
                        <option value="perdido_sustraido">Perdido</option>
                      </select>
                    </div>

                    <!-- Bot√≥n Eliminar -->
                    <button class="btn-eliminar-unidad" (click)="eliminarUnidad(unidad)" title="Eliminar unidad"
                      [disabled]="isEquipoEnEdicion($any(m))">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>

      <!-- FILAS DE LIBROS -->
      <ng-container *ngIf="tipoSeleccionado === 'libros'">
        <div class="table-body">
          <ng-container *ngFor="let m of materialesFiltrados">
            <!-- FILA DE LIBRO -->
            <ng-container *ngIf="'ejemplares' in m">
              <div class="table-row row-libros" [class.expanded]="isFilaExpandida(m.id)">
                <!-- Foto (Placeholder o similar) -->
                <div class="td td-foto">
                  <div class="thumb-placeholder">üìö</div>
                </div>

                <!-- Categor√≠a -->
                <div class="td td-categoria">
                  {{ m.categoria?.nombre || 'Sin cat.' }}
                </div>

                <!-- T√≠tulo -->
                <div class="td td-titulo clickable" [title]="$any(m).titulo" (click)="toggleFila(m.id)">
                  {{ $any(m).titulo }}
                </div>

                <!-- Autor -->
                <div class="td td-autor">
                  {{ $any(m).autor || '---' }}
                </div>

                <!-- Editorial -->
                <div class="td td-editorial">
                  {{ $any(m).editorial || '---' }}
                </div>

                <!-- Disponibles -->
                <div class="td td-count-disp">
                  <span class="count-pill disp">{{ getEjemplaresDisponiblesCount($any(m)) }}</span>
                </div>

                <!-- Totales -->
                <div class="td td-count-total">
                  <span class="count-pill total">{{ $any(m).ejemplares?.length || 0 }}</span>
                </div>

                <!-- Acciones -->
                <div class="td td-acciones">
                  <button class="btn-editar" (click)="$any(m).titulo ? editarLibro($any(m)) : null"
                    title="Editar"></button>
                  <button class="btn-eliminar" (click)="eliminarMaterial(m, 'libro')" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </div>
              </div>

              <!-- SUBTABLA DE EJEMPLARES (desplegable simplificado) -->
              <div class="subtable-container-simple" *ngIf="isFilaExpandida(m.id)">

                <!-- MODO EDICI√ìN -->
                <div class="libro-edicion" *ngIf="isLibroEnEdicion($any(m))">

                  <h3 class="edicion-titulo">Editar Libro</h3>

                  <div class="edicion-form-libro">

                    <!-- T√≠tulo -->
                    <div class="form-field">
                      <label class="edicion-label">T√≠tulo *</label>
                      <input type="text" class="input-edicion" [(ngModel)]="libroEnEdicion!.titulo"
                        placeholder="T√≠tulo del libro">
                    </div>

                    <!-- Autor -->
                    <div class="form-field">
                      <label class="edicion-label">Autor</label>
                      <input type="text" class="input-edicion" [(ngModel)]="libroEnEdicion!.autor"
                        placeholder="Nombre del autor">
                    </div>

                    <!-- Editorial -->
                    <div class="form-field">
                      <label class="edicion-label">Editorial</label>
                      <input type="text" class="input-edicion" [(ngModel)]="libroEnEdicion!.editorial"
                        placeholder="Editorial">
                    </div>

                    <!-- Categor√≠a -->
                    <div class="form-field">
                      <label class="edicion-label">Categor√≠a *</label>
                      <select class="select-edicion" [(ngModel)]="libroEnEdicion!.categoria_codigo">
                        <option *ngFor="let catCodigo of getCategoriasDisponibles()" [value]="catCodigo">
                          {{ getNombreCategoriaPorCodigo(catCodigo) }}
                        </option>
                      </select>
                    </div>

                  </div>

                  <!-- Botones de acci√≥n -->
                  <div class="edicion-botones">
                    <button class="btn-cancelar-edicion" (click)="cancelarEdicionLibro()">
                      Cancelar
                    </button>
                    <button class="btn-guardar-edicion" (click)="guardarLibro()">
                      Guardar Cambios
                    </button>
                  </div>

                </div>

                <!-- MODO VISTA (normal) -->
                <div class="libro-detalle" *ngIf="!isLibroEnEdicion($any(m))">
                  <div class="libro-info-completa">
                    <h4>{{ $any(m).titulo }}</h4>
                    <p><strong>Autor:</strong> {{ $any(m).autor || 'No especificado' }}</p>
                    <p><strong>Editorial:</strong> {{ $any(m).editorial || 'No especificado' }}</p>
                    <p><strong>Categor√≠a:</strong> {{ getNombreCategoria(m) }}</p>
                    <p><strong>C√≥digo:</strong> {{ $any(m).libro_numero }}</p>
                  </div>
                </div>

                <!-- Separador -->
                <div class="subtable-divider"></div>

                <!-- Lista simple de ejemplares -->
                <div class="ejemplares-list">

                  <!-- Fila de ejemplar simple -->
                  <div class="ejemplar-row" *ngFor="let ejemplar of $any(m).ejemplares; let i = index">

                    <div class="ejemplar-numero">{{ i + 1 }}.</div>

                    <!-- C√≥digo de Barras (editable) -->
                    <div class="ejemplar-campo">
                      <label>C√≥digo de Barras:</label>
                      <input type="text" class="input-simple" [(ngModel)]="ejemplar.codigo_barra"
                        (blur)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion($any(m))">
                    </div>

                    <!-- Estanter√≠a (editable) -->
                    <div class="ejemplar-campo">
                      <label>Estanter√≠a:</label>
                      <input type="text" class="input-simple" [(ngModel)]="ejemplar.estanteria" placeholder="Ej: 014"
                        (blur)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion($any(m))">
                    </div>

                    <!-- Balda (editable) -->
                    <div class="ejemplar-campo">
                      <label>Balda:</label>
                      <input type="text" class="input-simple" [(ngModel)]="ejemplar.balda" placeholder="Ej: 6"
                        (blur)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion($any(m))">
                    </div>

                    <!-- Estado (select) -->
                    <div class="ejemplar-campo">
                      <label>Estado:</label>
                      <select class="select-simple" [(ngModel)]="ejemplar.estado"
                        (change)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion($any(m))">
                        <option *ngFor="let est of estadosDisponibles" [value]="est.valor">
                          {{ est.texto }}
                        </option>
                      </select>
                    </div>

                    <!-- Bot√≥n Eliminar -->
                    <button class="btn-eliminar-ejemplar" (click)="eliminarEjemplar(ejemplar)" title="Eliminar ejemplar"
                      [disabled]="isLibroEnEdicion($any(m))">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>

              </div>

            </ng-container>
          </ng-container>

        </div>

      </ng-container>

    </div>

    <!-- Modal A√±adir Material -->
    <app-aniadir-material [isOpen]="modalAnadirAbierto" (close)="cerrarModalAnadir()"
      (materialCreado)="onMaterialCreado()">
    </app-aniadir-material>

  </div>
</div>