<!-- Gesti√≥n de Materiales PAS -->
<div class="materiales">

  <!-- Header con t√≠tulo y bot√≥n -->
  <div class="header">
    <h1 class="page-title">Gesti√≥n de Materiales</h1>
    <button class="btn-anadir" (click)="abrirModalAnadirMaterial()">
      A√±adir Material
    </button>
  </div>

  <!-- Filtros -->
  <div class="filtros">

    <!-- NUEVO: Botones Libros/Equipos -->
    <div class="tipo-toggle">
      <button class="btn-tipo" [class.activo]="tipoActivo === 'libros'"
        (click)="tipoActivo = 'libros'; aplicarFiltros()">
        Libros
      </button>
      <button class="btn-tipo" [class.activo]="tipoActivo === 'equipos'"
        (click)="tipoActivo = 'equipos'; aplicarFiltros()">
        Equipos
      </button>
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="busqueda">
      <input type="text" class="input-busqueda" placeholder="Buscar por nombre, c√≥digo, marca..."
        [(ngModel)]="textoBusqueda" (input)="buscar()" />
    </div>

    <!-- Filtro Categor√≠a -->
    <div class="filtro">
      <select class="select-filtro" [(ngModel)]="filtroCategoria" (change)="aplicarFiltros()">
        <option value="">Todas las categor√≠as</option>
        <option *ngFor="let catCodigo of getCategoriasDisponibles()" [value]="catCodigo">
          {{ getNombreCategoriaPorCodigo(catCodigo) }}
        </option>
      </select>
    </div>

    <!-- Filtro Estado -->
    <div class="filtro">
      <select class="select-filtro" [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
        <option value="">Todos los estados</option>
        <option value="disponible">Disponible</option>
        <option value="no_disponible">No disponible</option>
      </select>
    </div>

  </div>

  <!-- Tabla de materiales -->
  <div class="table-container">

    <!-- Header tabla -->
    <div class="table-header">
      <!-- Encabezados para EQUIPOS -->
      <ng-container *ngIf="tipoActivo === 'equipos'">
        <div class="th th-codigo">C√≥digo</div>
        <div class="th th-nombre">Nombre</div>
        <div class="th th-categoria">Categor√≠a</div>
        <div class="th th-marca">Marca</div>
        <div class="th th-modelo">Modelo</div>
        <div class="th th-unidades">Unidades</div>
        <div class="th th-acciones">Acciones</div>
      </ng-container>

      <!-- Encabezados para LIBROS -->
      <ng-container *ngIf="tipoActivo === 'libros'">
        <div class="th th-codigo">C√≥digo</div>
        <div class="th th-titulo">T√≠tulo</div>
        <div class="th th-autor">Autor</div>
        <div class="th th-editorial">Editorial</div>
        <div class="th th-categoria">Categor√≠a</div>
        <div class="th th-ejemplares">Ejemplares</div>
        <div class="th th-acciones">Acciones</div>
      </ng-container>
    </div>

    <!-- Body tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <p>Cargando materiales...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin materiales (Equipos) -->
      <div class="empty-state"
        *ngIf="!isLoading && !errorMessage && tipoActivo === 'equipos' && equiposFiltrados.length === 0">
        <p>No hay equipos disponibles</p>
      </div>

      <!-- Sin materiales (Libros) -->
      <div class="empty-state"
        *ngIf="!isLoading && !errorMessage && tipoActivo === 'libros' && librosFiltrados.length === 0">
        <p>No hay libros disponibles</p>
      </div>

      <!-- FILAS DE EQUIPOS -->
      <ng-container *ngIf="tipoActivo === 'equipos'">
        <ng-container *ngFor="let equipo of equiposFiltrados">

          <!-- FILA PRINCIPAL DEL EQUIPO -->
          <div class="table-row" [class.expanded]="isFilaExpandida(equipo.id)">

            <!-- C√≥digo -->
            <div class="td td-codigo">
              {{ equipo.categoria_codigo }}{{ equipo.id }}
            </div>

            <!-- Nombre (Marca + Modelo) -->
            <div class="td td-nombre">
              {{ equipo.marca }} {{ equipo.modelo }}
            </div>

            <!-- Categor√≠a -->
            <div class="td td-categoria">
              {{ getNombreCategoria(equipo) }}
            </div>

            <!-- Marca -->
            <div class="td td-marca">
              {{ equipo.marca }}
            </div>

            <!-- Modelo -->
            <div class="td td-modelo">
              {{ equipo.modelo }}
            </div>

            <!-- Unidades (solo n√∫mero) -->
            <div class="td td-unidades">
              <button class="btn-numero-unidades" (click)="toggleFila(equipo.id)">
                {{ equipo.unidades?.length || 0 }}
              </button>
            </div>

            <!-- Acciones -->
            <div class="td td-acciones">
              <button class="btn-editar" (click)="editarEquipo(equipo)" title="Editar equipo">
                ‚úèÔ∏è
              </button>
              <button class="btn-eliminar" (click)="eliminarMaterial(equipo, 'equipo')" title="Eliminar equipo">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- SUBTABLA DE UNIDADES (desplegable simplificado) -->
          <div class="subtable-container-simple" *ngIf="isFilaExpandida(equipo.id)">

            <!-- MODO EDICI√ìN -->
            <div class="equipo-edicion" *ngIf="isEquipoEnEdicion(equipo)">

              <h3 class="edicion-titulo">Editar Equipo</h3>

              <div class="edicion-grid">

                <!-- Columna Izquierda: Imagen -->
                <div class="edicion-imagen-seccion">
                  <label class="edicion-label">Imagen del equipo</label>

                  <div class="imagen-upload">
                    <img *ngIf="equipoEnEdicion!.foto_url" [src]="equipoEnEdicion!.foto_url"
                      [alt]="equipoEnEdicion!.marca + ' ' + equipoEnEdicion!.modelo">
                    <div *ngIf="!equipoEnEdicion!.foto_url" class="imagen-placeholder">
                      üì∑
                    </div>
                  </div>

                  <input type="file" id="inputImagen" accept="image/*" (change)="onArchivoImagenSeleccionado($event)"
                    style="display: none;">

                  <label for="inputImagen" class="btn-seleccionar-imagen">
                    Seleccionar imagen
                  </label>

                  <p class="imagen-info">Formatos: JPG, PNG, GIF (m√°x. 5MB)</p>
                </div>

                <!-- Columna Derecha: Formulario -->
                <div class="edicion-form-seccion">

                  <!-- Marca -->
                  <div class="form-field">
                    <label class="edicion-label">Marca *</label>
                    <input type="text" class="input-edicion" [(ngModel)]="equipoEnEdicion!.marca"
                      placeholder="Ej: Canon">
                  </div>

                  <!-- Modelo -->
                  <div class="form-field">
                    <label class="edicion-label">Modelo *</label>
                    <input type="text" class="input-edicion" [(ngModel)]="equipoEnEdicion!.modelo"
                      placeholder="Ej: EOS 250D">
                  </div>

                  <!-- Categor√≠a -->
                  <div class="form-field">
                    <label class="edicion-label">Categor√≠a *</label>
                    <select class="select-edicion" [(ngModel)]="equipoEnEdicion!.categoria_codigo">
                      <option *ngFor="let catCodigo of getCategoriasDisponibles()" [value]="catCodigo">
                        {{ getNombreCategoriaPorCodigo(catCodigo) }}
                      </option>
                    </select>
                  </div>

                  <!-- Descripci√≥n -->
                  <div class="form-field">
                    <label class="edicion-label">Descripci√≥n</label>
                    <textarea class="textarea-edicion" [(ngModel)]="equipoEnEdicion!.descripcion"
                      placeholder="Descripci√≥n opcional del equipo" rows="3"></textarea>
                  </div>

                </div>

              </div>

              <!-- Botones de acci√≥n -->
              <div class="edicion-botones">
                <button class="btn-cancelar-edicion" (click)="cancelarEdicion()">
                  Cancelar
                </button>
                <button class="btn-guardar-edicion" (click)="guardarEquipo()">
                  Guardar Cambios
                </button>
              </div>

            </div>

            <!-- MODO VISTA (normal) -->
            <div class="equipo-detalle" *ngIf="!isEquipoEnEdicion(equipo)">
              <div class="equipo-imagen">
                <img *ngIf="equipo.foto_url" [src]="equipo.foto_url" [alt]="equipo.marca + ' ' + equipo.modelo">
                <div *ngIf="!equipo.foto_url" class="imagen-placeholder">
                </div>
              </div>

              <div class="equipo-info">
                <h4>{{ equipo.marca }} {{ equipo.modelo }}</h4>
                <p><strong>Categor√≠a:</strong> {{ getNombreCategoria(equipo) }}</p>
                <p *ngIf="equipo.descripcion"><strong>Descripci√≥n:</strong> {{ equipo.descripcion }}</p>
              </div>
            </div>

            <!-- Separador -->
            <div class="subtable-divider"></div>

            <!-- Lista simple de unidades -->
            <div class="unidades-list">

              <!-- Fila de unidad simple -->
              <div class="unidad-row" *ngFor="let unidad of equipo.unidades; let i = index">

                <div class="unidad-numero">{{ i + 1 }}.</div>

                <!-- N√∫mero de Serie (editable) -->
                <div class="unidad-campo">
                  <label>N¬∞ Serie:</label>
                  <input type="text" class="input-simple" [(ngModel)]="unidad.numero_serie"
                    placeholder="Sin n√∫mero de serie" (blur)="guardarCambiosUnidad(unidad)"
                    [disabled]="isEquipoEnEdicion(equipo)">
                </div>

                <!-- C√≥digo de Barras (editable) -->
                <div class="unidad-campo">
                  <label>C√≥digo:</label>
                  <input type="text" class="input-simple" [(ngModel)]="unidad.codigo_barra"
                    (blur)="guardarCambiosUnidad(unidad)" [disabled]="isEquipoEnEdicion(equipo)">
                </div>

                <!-- Estado (select) -->
                <div class="unidad-campo">
                  <label>Estado:</label>
                  <select class="select-simple" [(ngModel)]="unidad.estado" (change)="guardarCambiosUnidad(unidad)"
                    [disabled]="isEquipoEnEdicion(equipo)">
                    <option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
                      {{ estado.texto }}
                    </option>
                  </select>
                </div>

                <!-- Bot√≥n Eliminar -->
                <button class="btn-eliminar-unidad" (click)="eliminarUnidad(unidad)" title="Eliminar unidad"
                  [disabled]="isEquipoEnEdicion(equipo)">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- FILAS DE LIBROS -->
      <ng-container *ngIf="tipoActivo === 'libros'">
        <ng-container *ngFor="let libro of librosFiltrados">

          <!-- FILA PRINCIPAL DEL LIBRO -->
          <div class="table-row table-row-libro" [class.expanded]="isFilaExpandida(libro.id)">

            <!-- C√≥digo -->
            <div class="td td-codigo">
              {{ libro.libro_numero }}
            </div>

            <!-- T√≠tulo -->
            <div class="td td-titulo">
              {{ libro.titulo }}
            </div>

            <!-- Autor -->
            <div class="td td-autor">
              {{ libro.autor || 'N/A' }}
            </div>

            <!-- Editorial -->
            <div class="td td-editorial">
              {{ libro.editorial || 'N/A' }}
            </div>

            <!-- Categor√≠a -->
            <div class="td td-categoria">
              {{ getNombreCategoria(libro) }}
            </div>

            <!-- Ejemplares (solo n√∫mero) -->
            <div class="td td-ejemplares">
              <button class="btn-numero-ejemplares" (click)="toggleFila(libro.id)">
                {{ libro.ejemplares?.length || 0 }}
              </button>
            </div>

            <!-- Acciones -->
            <div class="td td-acciones">
              <button class="btn-editar" (click)="editarLibro(libro)" title="Editar libro">
                ‚úèÔ∏è
              </button>
              <button class="btn-eliminar" (click)="eliminarMaterial(libro, 'libro')" title="Eliminar libro">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- SUBTABLA DE EJEMPLARES (desplegable simplificado) -->
          <div class="subtable-container-simple" *ngIf="isFilaExpandida(libro.id)">

            <!-- MODO EDICI√ìN -->
            <div class="libro-edicion" *ngIf="isLibroEnEdicion(libro)">

              <h3 class="edicion-titulo">Editar Libro</h3>

              <div class="edicion-form-libro">

                <!-- T√≠tulo -->
                <div class="form-field">
                  <label class="edicion-label">T√≠tulo *</label>
                  <input type="text" class="input-edicion" [(ngModel)]="libroEnEdicion!.titulo"
                    placeholder="T√≠tulo del libro">
                </div>

                <!-- Autor -->
                <div class="form-field">
                  <label class="edicion-label">Autor</label>
                  <input type="text" class="input-edicion" [(ngModel)]="libroEnEdicion!.autor"
                    placeholder="Nombre del autor">
                </div>

                <!-- Editorial -->
                <div class="form-field">
                  <label class="edicion-label">Editorial</label>
                  <input type="text" class="input-edicion" [(ngModel)]="libroEnEdicion!.editorial"
                    placeholder="Editorial">
                </div>

                <!-- Categor√≠a -->
                <div class="form-field">
                  <label class="edicion-label">Categor√≠a *</label>
                  <select class="select-edicion" [(ngModel)]="libroEnEdicion!.categoria_codigo">
                    <option *ngFor="let catCodigo of getCategoriasDisponibles()" [value]="catCodigo">
                      {{ getNombreCategoriaPorCodigo(catCodigo) }}
                    </option>
                  </select>
                </div>

              </div>

              <!-- Botones de acci√≥n -->
              <div class="edicion-botones">
                <button class="btn-cancelar-edicion" (click)="cancelarEdicionLibro()">
                  Cancelar
                </button>
                <button class="btn-guardar-edicion" (click)="guardarLibro()">
                  Guardar Cambios
                </button>
              </div>

            </div>

            <!-- MODO VISTA (normal) -->
            <div class="libro-detalle" *ngIf="!isLibroEnEdicion(libro)">
              <div class="libro-info-completa">
                <h4>{{ libro.titulo }}</h4>
                <p><strong>Autor:</strong> {{ libro.autor || 'No especificado' }}</p>
                <p><strong>Editorial:</strong> {{ libro.editorial || 'No especificado' }}</p>
                <p><strong>Categor√≠a:</strong> {{ getNombreCategoria(libro) }}</p>
                <p><strong>C√≥digo:</strong> {{ libro.libro_numero }}</p>
              </div>
            </div>

            <!-- Separador -->
            <div class="subtable-divider"></div>

            <!-- Lista simple de ejemplares -->
            <div class="ejemplares-list">

              <!-- Fila de ejemplar simple -->
              <div class="ejemplar-row" *ngFor="let ejemplar of libro.ejemplares; let i = index">

                <div class="ejemplar-numero">{{ i + 1 }}.</div>

                <!-- C√≥digo de Barras (editable) -->
                <div class="ejemplar-campo">
                  <label>C√≥digo de Barras:</label>
                  <input type="text" class="input-simple" [(ngModel)]="ejemplar.codigo_barra"
                    (blur)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion(libro)">
                </div>

                <!-- Estanter√≠a (editable) -->
                <div class="ejemplar-campo">
                  <label>Estanter√≠a:</label>
                  <input type="text" class="input-simple" [(ngModel)]="ejemplar.estanteria" placeholder="Ej: 014"
                    (blur)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion(libro)">
                </div>

                <!-- Balda (editable) -->
                <div class="ejemplar-campo">
                  <label>Balda:</label>
                  <input type="text" class="input-simple" [(ngModel)]="ejemplar.balda" placeholder="Ej: 6"
                    (blur)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion(libro)">
                </div>

                <!-- Estado (select) -->
                <div class="ejemplar-campo">
                  <label>Estado:</label>
                  <select class="select-simple" [(ngModel)]="ejemplar.estado"
                    (change)="guardarCambiosEjemplar(ejemplar)" [disabled]="isLibroEnEdicion(libro)">
                    <option *ngFor="let estado of estadosDisponibles" [value]="estado.valor">
                      {{ estado.texto }}
                    </option>
                  </select>
                </div>

                <!-- Bot√≥n Eliminar -->
                <button class="btn-eliminar-ejemplar" (click)="eliminarEjemplar(ejemplar)" title="Eliminar ejemplar"
                  [disabled]="isLibroEnEdicion(libro)">
                  üóëÔ∏è
                </button>
              </div>
            </div>

          </div>

        </ng-container>
      </ng-container>

    </div>

  </div>

</div>