<!-- Gesti√≥n de Materiales PAS -->
<div class="materiales">

  <!-- Header con t√≠tulo y bot√≥n -->
  <div class="header">
    <h1 class="page-title">Gesti√≥n de Materiales</h1>
    <button class="btn-anadir" (click)="abrirModalAnadirMaterial()">
      A√±adir Material
    </button>
  </div>

  <div class="filtros-container">
    <div class="filtros-basicos">
      <div class="tipo-toggle">
        <button class="btn-tipo" [class.activo]="tipoSeleccionado === 'libros'" (click)="setTipo('libros')">
          <i class="fas fa-book"></i> Libros
        </button>
        <button class="btn-tipo" [class.activo]="tipoSeleccionado === 'equipos'" (click)="setTipo('equipos')">
          <i class="fas fa-laptop"></i> Equipos
        </button>
      </div>

      <div class="busqueda">
        <input type="text" class="input-busqueda" [(ngModel)]="busqueda" (input)="aplicarFiltros()"
          [placeholder]="tipoSeleccionado === 'libros' ? 'Buscar por t√≠tulo, autor o ISBN...' : 'Buscar por marca, modelo o descripci√≥n...'">
      </div>

      <div class="filtro">
        <select class="select-filtro" [(ngModel)]="filtroCategoria" (change)="aplicarFiltros()">
          <option value="">Todas las categor√≠as</option>
          <ng-container *ngIf="tipoSeleccionado === 'equipos'">
            <option *ngFor="let cat of categorias" [value]="cat.id">
              {{ cat.nombre }}
            </option>
          </ng-container>
          <ng-container *ngIf="tipoSeleccionado === 'libros'">
            <option *ngFor="let gen of generos" [value]="gen.id">
              {{ gen.nombre }} (Libro)
            </option>
          </ng-container>
        </select>
      </div>

      <div class="filtro" *ngIf="tipoSeleccionado === 'equipos'">
        <select class="select-filtro" [(ngModel)]="filtroNombre" (change)="aplicarFiltros()">
          <option value="">Todos los nombres</option>
          <option *ngFor="let n of getNombresDisponibles()" [value]="n.id">
            {{ n.nombre }}
          </option>
        </select>
      </div>

      <button class="btn-reset" (click)="limpiarFiltros()" title="Limpiar todos los filtros">
        Limpiar
      </button>
    </div>

    <!-- FILTROS AVANZADOS (Rangos de disponibilidad) -->
    <div class="filtros-avanzados">
      <div class="rango-filtro">
        <label>Disponibles:</label>
        <div class="inputs-rango">
          <input type="number" class="input-mini" [(ngModel)]="minDisponibles" (input)="aplicarFiltros()"
            placeholder="M√≠n">
          <span>-</span>
          <input type="number" class="input-mini" [(ngModel)]="maxDisponibles" (input)="aplicarFiltros()"
            placeholder="M√°x">
        </div>
      </div>

      <div class="rango-filtro">
        <label>Totales:</label>
        <div class="inputs-rango">
          <input type="number" class="input-mini" [(ngModel)]="minTotales" (input)="aplicarFiltros()" placeholder="M√≠n">
          <span>-</span>
          <input type="number" class="input-mini" [(ngModel)]="maxTotales" (input)="aplicarFiltros()" placeholder="M√°x">
        </div>
      </div>
    </div>

  </div>

  <!-- Tabla de materiales -->
  <div class="table-container">

    <!-- Header tabla -->
    <div class="table-header" [ngClass]="tipoSeleccionado === 'equipos' ? 'header-equipos' : 'header-libros'">
      <!-- Encabezados para EQUIPOS -->
      <ng-container *ngIf="tipoSeleccionado === 'equipos'">
        <div class="th">Foto</div>
        <div class="th sortable" (click)="toggleSort('categoria')">
          Categor√≠a
          <span class="sort-icon" *ngIf="sortColumn === 'categoria'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th sortable" (click)="toggleSort('nombre')">
          Nombre
          <span class="sort-icon" *ngIf="sortColumn === 'nombre'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th sortable" (click)="toggleSort('marca')">
          Marca
          <span class="sort-icon" *ngIf="sortColumn === 'marca'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th sortable" (click)="toggleSort('modelo')">
          Modelo
          <span class="sort-icon" *ngIf="sortColumn === 'modelo'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th">Descripci√≥n</div>
        <div class="th th-centrado sortable" (click)="toggleSort('disp')">
          Disp.
          <span class="sort-icon" *ngIf="sortColumn === 'disp'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-centrado sortable" (click)="toggleSort('total')">
          Total
          <span class="sort-icon" *ngIf="sortColumn === 'total'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th">Acciones</div>
      </ng-container>

      <!-- Encabezados para LIBROS -->
      <ng-container *ngIf="tipoSeleccionado === 'libros'">
        <div class="th th-foto sortable" (click)="toggleSort('codigo')">
          Portada
          <span class="sort-icon" *ngIf="sortColumn === 'codigo'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-categoria sortable" (click)="toggleSort('categoria')">
          Categor√≠a
          <span class="sort-icon" *ngIf="sortColumn === 'categoria'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-titulo sortable" (click)="toggleSort('nombre')">
          T√≠tulo
          <span class="sort-icon" *ngIf="sortColumn === 'nombre'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-autor sortable" (click)="toggleSort('autor')">
          Autor
          <span class="sort-icon" *ngIf="sortColumn === 'autor'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-editorial sortable" (click)="toggleSort('editorial')">
          Editorial
          <span class="sort-icon" *ngIf="sortColumn === 'editorial'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-centrado sortable" (click)="toggleSort('disp')">
          Disp.
          <span class="sort-icon" *ngIf="sortColumn === 'disp'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-centrado sortable" (click)="toggleSort('total')">
          Total
          <span class="sort-icon" *ngIf="sortColumn === 'total'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
        </div>
        <div class="th th-acciones">Acciones</div>
      </ng-container>
    </div>

    <!-- Body tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <p>Cargando materiales...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin materiales (Equipos) -->
      <div class="empty-state"
        *ngIf="!isLoading && !errorMessage && tipoSeleccionado === 'equipos' && materialesFiltrados.length === 0">
        <p>No hay equipos disponibles</p>
      </div>

      <!-- Sin materiales (Libros) -->
      <div class="empty-state"
        *ngIf="!isLoading && !errorMessage && tipoSeleccionado === 'libros' && materialesFiltrados.length === 0">
        <p>No hay libros disponibles</p>
      </div>

      <!-- FILAS DE EQUIPOS -->
      <ng-container *ngIf="tipoSeleccionado === 'equipos'">
        <ng-container *ngFor="let m of materialesFiltrados">
          <ng-container *ngIf="$any(m).unidades">
            <!-- FILA DE EQUIPO -->
            <div class="table-row row-equipos" [class.expanded]="isFilaExpandida(m.id)">
              <div class="td td-foto">
                <img *ngIf="$any(m).foto_url" [src]="getImageUrl($any(m).foto_url)" alt="Foto material"
                  class="thumb-material">
                <div *ngIf="!$any(m).foto_url" class="thumb-placeholder">üì∑</div>
              </div>
              <div class="td td-categoria">
                {{ getNombreCategoria(m) }}
              </div>
              <div class="td td-nombre clickable" (click)="toggleFila(m.id)">
                {{ $any(m).Nombre?.nombre || 'Sin nombre' }}
              </div>
              <div class="td td-marca">
                {{ $any(m).marca }}
              </div>
              <div class="td td-modelo">
                {{ $any(m).modelo }}
              </div>
              <div class="td td-descripcion" [title]="$any(m).descripcion">
                {{ $any(m).descripcion || '---' }}
              </div>
              <div class="td td-count-disp">
                <span class="count-pill disp">{{ getUnidadesDisponiblesCount($any(m)) }}</span>
              </div>
              <div class="td td-count-total">
                <span class="count-pill total">{{ $any(m).unidades?.length || 0 }}</span>
              </div>
              <div class="td td-acciones">
                <button class="btn-accion-icono btn-ver" [class.activo]="isFilaExpandida(m.id)"
                  (click)="toggleFila(m.id)" title="Ver unidades/detalles">
                  <i class="fas" [ngClass]="isFilaExpandida(m.id) ? 'fa-chevron-up' : 'fa-eye'"></i>
                </button>
                <button class="btn-accion-icono btn-editar-row" (click)="editarEquipo($any(m))" title="Editar equipo">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-accion-icono btn-eliminar-row" (click)="eliminarMaterial(m, 'equipo')"
                  title="Eliminar equipo">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>

            <!-- EXPANSI√ìN DE EQUIPO -->
            <div class="subtable-container-simple" *ngIf="isFilaExpandida(m.id)">

              <!-- GESTI√ìN DE UNIDADES -->
              <div class="unidades-seccion">
                <div class="seccion-header">
                  <h3 class="seccion-titulo"><i class="fas fa-boxes"></i> Gesti√≥n de Unidades</h3>
                </div>
                <div class="unidades-list">
                  <div class="unidad-row" *ngFor="let unidad of $any(m).unidades; let i = index">
                    <div class="unidad-numero">{{ i + 1 }}.</div>
                    <div class="unidad-campo">
                      <label>N¬∞ Serie:</label>
                      <input type="text" class="input-simple" [(ngModel)]="unidad.numero_serie" placeholder="Sin serie"
                        (blur)="guardarCambiosUnidad(unidad)">
                    </div>
                    <div class="unidad-campo">
                      <label>C√≥digo:</label>
                      <input type="text" class="input-simple" [(ngModel)]="unidad.codigo_barra"
                        (blur)="guardarCambiosUnidad(unidad)">
                    </div>
                    <div class="unidad-campo">
                      <label>Pr√©stamo:</label>
                      <span class="badge" [ngClass]="getPrestadoBadgeClass(unidad.esta_prestado)">
                        {{ getPrestadoTexto(unidad.esta_prestado) }}
                      </span>
                    </div>
                    <div class="unidad-campo">
                      <label>Estado F√≠sico:</label>
                      <select class="select-simple" [(ngModel)]="unidad.estado_fisico"
                        (change)="guardarCambiosUnidad(unidad)" [ngClass]="getFisicoBadgeClass(unidad.estado_fisico)">
                        <option value="funciona">Funcional</option>
                        <option value="en_reparacion">En reparaci√≥n</option>
                        <option value="no_funciona">No funciona</option>
                        <option value="falla">Con fallos</option>
                        <option value="perdido_sustraido">Perdido</option>
                      </select>
                    </div>
                    <button class="btn-eliminar-unidad" (click)="eliminarUnidad(unidad)"
                      title="Eliminar unidad">üóëÔ∏è</button>
                  </div>
                  <div class="aniadir-unidad-container">
                    <button class="btn-aniadir-simple" (click)="aniadirUnidad($any(m))" [disabled]="isAniadiendoUnidad">
                      <i class="fas fa-plus"></i> A√±adir Unidad
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>

      <!-- FILAS DE LIBROS -->
      <ng-container *ngIf="tipoSeleccionado === 'libros'">
        <ng-container *ngFor="let m of materialesFiltrados">
          <ng-container *ngIf="$any(m).ejemplares">
            <!-- FILA DE LIBRO -->
            <div class="table-row row-libros" [class.expanded]="isFilaExpandida(m.id)">
              <div class="td td-foto">
                <img *ngIf="$any(m).foto_url" [src]="getImageUrl($any(m).foto_url)" alt="Portada"
                  class="thumb-material">
                <div *ngIf="!$any(m).foto_url" class="thumb-placeholder">üìö</div>
              </div>
              <div class="td td-categoria">
                {{ getNombreCategoria(m) }}
              </div>
              <div class="td td-titulo clickable" [title]="$any(m).titulo" (click)="toggleFila(m.id)">
                {{ $any(m).titulo }}
              </div>
              <div class="td td-autor">
                {{ $any(m).autor || '---' }}
              </div>
              <div class="td td-editorial" [title]="$any(m).editorial">
                {{ $any(m).editorial || '---' }}
              </div>
              <div class="td td-count-disp">
                <span class="count-pill disp">{{ getEjemplaresDisponiblesCount($any(m)) }}</span>
              </div>
              <div class="td td-count-total">
                <span class="count-pill total">{{ $any(m).ejemplares?.length || 0 }}</span>
              </div>
              <div class="td td-acciones">
                <button class="btn-accion-icono btn-ver" [class.activo]="isFilaExpandida(m.id)"
                  (click)="toggleFila(m.id)" title="Ver ejemplares/detalles">
                  <i class="fas" [ngClass]="isFilaExpandida(m.id) ? 'fa-chevron-up' : 'fa-eye'"></i>
                </button>
                <button class="btn-accion-icono btn-editar-row" (click)="$any(m).titulo ? editarLibro($any(m)) : null"
                  title="Editar libro">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-accion-icono btn-eliminar-row" (click)="eliminarMaterial(m, 'libro')"
                  title="Eliminar libro">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>

            <!-- EXPANSI√ìN DE LIBRO -->
            <div class="subtable-container-simple" *ngIf="isFilaExpandida(m.id)">

              <!-- GESTI√ìN DE EJEMPLARES -->
              <div class="unidades-seccion">
                <div class="seccion-header">
                  <h3 class="seccion-titulo"><i class="fas fa-book-open"></i> Gesti√≥n de Ejemplares</h3>
                </div>
                <div class="ejemplares-list">
                  <div class="ejemplar-row" *ngFor="let ejemplar of $any(m).ejemplares; let i = index">
                    <div class="ejemplar-numero">{{ i + 1 }}.</div>
                    <div class="ejemplar-campo">
                      <label>Barras:</label>
                      <input type="text" class="input-simple" [(ngModel)]="ejemplar.codigo_barra"
                        (blur)="guardarCambiosEjemplar(ejemplar)">
                    </div>
                    <div class="ejemplar-campo">
                      <label>ID Registro (C122):</label>
                      <input type="text" class="input-simple" [(ngModel)]="ejemplar.c122003" placeholder="---"
                        (blur)="guardarCambiosEjemplar(ejemplar)">
                    </div>
                    <div class="ejemplar-campo">
                      <label>Ubicaci√≥n:</label>
                      <div class="ubicacion-inputs">
                        <input type="text" class="input-simple small" [(ngModel)]="ejemplar.estanteria"
                          placeholder="Est." (blur)="guardarCambiosEjemplar(ejemplar)">
                        <input type="text" class="input-simple small" [(ngModel)]="ejemplar.balda" placeholder="Balda"
                          (blur)="guardarCambiosEjemplar(ejemplar)">
                      </div>
                    </div>
                    <div class="ejemplar-campo">
                      <label>Estado:</label>
                      <select class="select-simple" [(ngModel)]="ejemplar.estado"
                        (change)="guardarCambiosEjemplar(ejemplar)" [ngClass]="getClaseBadge(ejemplar.estado)">
                        <option *ngFor="let est of estadosDisponibles" [value]="est.valor">{{ est.texto }}</option>
                      </select>
                    </div>
                    <button class="btn-eliminar-ejemplar" (click)="eliminarEjemplar(ejemplar)"
                      title="Eliminar ejemplar">üóëÔ∏è</button>
                  </div>
                </div>
                <div class="aniadir-unidad-container">
                  <button class="btn-aniadir-simple" (click)="aniadirEjemplar($any(m))" [disabled]="isAniadiendoUnidad">
                    <i class="fas fa-plus"></i> A√±adir Ejemplar
                  </button>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>
    </div> <!-- .table-body -->
  </div> <!-- .table-container -->

  <!-- Modal A√±adir/Editar Material -->
  <app-aniadir-material [isOpen]="modalAnadirAbierto" [mode]="modalMode" [editData]="materialAEditar"
    (close)="cerrarModalAnadir()" (materialCreado)="cargarMateriales()">
  </app-aniadir-material>

  <!-- Modal de Confirmaci√≥n y Notificaci√≥n -->
  <app-modal [mostrar]="modalData.mostrar" [tipo]="modalData.tipo" [titulo]="modalData.titulo"
    [mensaje]="modalData.mensaje" [esConfirmacion]="modalData.esConfirmacion"
    [textoBtnPrincipal]="modalData.textoBtnPrincipal" (cerrar)="cerrarModalConfirmacion()"
    (confirmar)="modalData.accion(); cerrarModalConfirmacion()">
  </app-modal>

</div> <!-- .materiales -->