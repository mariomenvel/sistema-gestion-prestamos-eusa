<!-- Préstamos Activos PAS -->
<div class="prestamos-activos">

  <!-- Encabezado -->
  <div class="header">
    <h1 class="page-title">Préstamos Activos</h1>
    <p class="page-subtitle">Listado de todos los préstamos activos pendientes de devolución</p>
  </div>

  <!-- Barra de Filtros -->
  <div class="filtros-container">
    <div class="busqueda-wrapper">
      <input type="text" class="input-busqueda" placeholder="Buscar por alumno (nombre, email, código)..."
        [(ngModel)]="textoBusqueda" (input)="aplicarFiltros()" />
    </div>

    <div class="selects-wrapper">
      <!-- Botón Limpiar -->
      <button class="btn-limpiar" (click)="limpiarFiltros()" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Tabla de préstamos -->
  <div class="table-container">

    <!-- Header de la tabla -->
    <div class="table-header">
      <div class="th th-alumno sortable" (click)="ordenar('alumno')">
        Alumno
        <span class="sort-icon" [class.active]="sortColumn === 'alumno'">
          {{ sortColumn === 'alumno' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-tipo">Tipo</div>
      <div class="th th-material">Material</div>
      <div class="th th-fecha-prestamo">Fecha Préstamo</div>
      <div class="th th-fecha-devolucion sortable" (click)="ordenar('fechaDevolucion')">
        Fecha Devolución
        <span class="sort-icon" [class.active]="sortColumn === 'fechaDevolucion'">
          {{ sortColumn === 'fechaDevolucion' ? (sortDirection === 'asc' ? '↑' : '↓') : '↕' }}
        </span>
      </div>
      <div class="th th-accion">Acción</div>
    </div>

    <!-- Body de la tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Cargando préstamos...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin préstamos -->
      <div class="empty-state" *ngIf="!isLoading && !errorMessage && prestamosFiltrados.length === 0">
        <p>No hay préstamos activos que coincidan con la búsqueda</p>
      </div>

      <!-- Filas de préstamos -->
      <div class="table-row" *ngFor="let prestamo of prestamosFiltrados" [class.vencido]="esVencido(prestamo)">
        <div class="td td-alumno">
          <button class="link-alumno" (click)="abrirPerfilAlumno(prestamo, $event)"
            [attr.aria-label]="'Ver perfil de ' + getNombreUsuario(prestamo)">
            {{ getNombreUsuario(prestamo) }}
          </button>
        </div>

        <!-- Columna: Tipo -->
        <div class="td td-tipo">
          <span class="badge-tipo">
            {{ getTipoTexto(prestamo.tipo) }}
          </span>
        </div>

        <!-- Columna: Material -->
        <div class="td td-material">
          <!-- Si tiene múltiples materiales, mostrar como enlace clickeable -->
          <button *ngIf="tieneMultiplesMateriales(prestamo)" class="material-link"
            (click)="verDetallesMateriales(prestamo, $event)" aria-label="Ver detalles de materiales">
            {{ getNombreMaterial(prestamo) }}
          </button>

          <!-- Si tiene un solo material, mostrar texto normal -->
          <span *ngIf="!tieneMultiplesMateriales(prestamo)">
            {{ getNombreMaterial(prestamo) }}
          </span>
        </div>

        <!-- Columna: Fecha Préstamo -->
        <div class="td td-fecha-prestamo">
          {{ formatearFecha(prestamo.fecha_inicio) }}
        </div>

        <!-- Columna: Fecha Devolución -->
        <div class="td td-fecha-devolucion">
          <span class="fecha-wrapper">
            <svg class="icono-calendario" [class.vencido]="esVencido(prestamo)" xmlns="http://www.w3.org/2000/svg"
              width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            {{ formatearFecha(prestamo.fecha_devolucion_prevista) }}
          </span>
        </div>

        <!-- Columna: Acción -->
        <div class="td td-accion">
          <button class="btn-devolucion" (click)="abrirModalDevolucion(prestamo)"
            [attr.aria-label]="'Registrar devolución para ' + getNombreUsuario(prestamo)">
            Registrar Devolución
          </button>
        </div>

      </div>

    </div>

  </div>

</div>

<!-- MODAL: Detalle de Materiales -->
<div class="modal-overlay" *ngIf="mostrarModalMateriales" (click)="cerrarModalMateriales()" role="dialog"
  aria-modal="true" aria-labelledby="titulo-materiales-pa">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Botón cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalMateriales()" aria-label="Cerrar modal">✕</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title" id="titulo-materiales-pa">Materiales del Préstamo</h2>
    </div>

    <!-- Info del alumno -->
    <div class="modal-alumno" *ngIf="prestamoSeleccionado">
      <span class="alumno-label">Alumno:</span>
      <span class="alumno-nombre">{{ getNombreUsuario(prestamoSeleccionado) }}</span>
    </div>

    <!-- Lista de materiales -->
    <div class="materiales-lista">
      <div class="material-item" *ngFor="let item of materialesSeleccionados; let i = index">
        <div class="material-numero">{{ i + 1 }}</div>
        <div class="material-info">
          <div class="material-nombre">{{ getNombreItem(item) }}</div>
          <div class="material-detalles">
            <span class="material-tipo">{{ getTipoItem(item) }}</span>
            <span class="material-codigo">Código: {{ getCodigoItem(item) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalMateriales()">Cerrar</button>
    </div>

  </div>
</div>

<!-- MODAL: Confirmar Devolución -->
<div class="modal-overlay" *ngIf="mostrarModalDevolucion" (click)="cerrarModalDevolucion()" role="dialog"
  aria-modal="true" aria-labelledby="titulo-devolucion">
  <div class="modal-card modal-devolucion" (click)="$event.stopPropagation()">

    <!-- Botón cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalDevolucion()" aria-label="Cerrar modal">✕</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title" id="titulo-devolucion">Registrar Devolución</h2>
    </div>

    <!-- Contenido -->
    <div class="devolucion-contenido" *ngIf="prestamoDevolucion">

      <!-- Info del alumno -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Alumno</div>
        <div class="seccion-valor">{{ getNombreUsuario(prestamoDevolucion) }}</div>
      </div>

      <!-- Tipo de préstamo -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Tipo de Préstamo</div>
        <div class="seccion-valor">
          <span class="badge-tipo-modal">{{ getTipoTexto(prestamoDevolucion.tipo) }}</span>
        </div>
      </div>

      <!-- Fecha de préstamo -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Fecha de Préstamo</div>
        <div class="seccion-valor">{{ formatearFecha(prestamoDevolucion.fecha_inicio) }}</div>
      </div>

      <!-- Fecha devolución prevista -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Fecha Devolución Prevista</div>
        <div class="seccion-valor" [class.texto-vencido]="esVencido(prestamoDevolucion)">
          {{ formatearFecha(prestamoDevolucion.fecha_devolucion_prevista) }}
          <span class="badge-vencido" *ngIf="esVencido(prestamoDevolucion)">VENCIDO</span>
        </div>
      </div>

      <!-- Materiales a devolver -->
      <div class="devolucion-materiales">
        <div class="materiales-header">
          <span class="materiales-titulo">Materiales a Devolver</span>
          <span class="materiales-count">{{ getMaterialesDevolucion().length }}</span>
        </div>

        <div class="materiales-lista-devolucion">
          <div class="material-devolucion-item" *ngFor="let item of getMaterialesDevolucion()">
            <div class="material-datos">
              <span class="material-nombre">{{ getNombreItem(item) }}</span>
              <span class="material-codigo">{{ getCodigoItem(item) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje de confirmación -->
      <div class="devolucion-aviso">
        <svg class="aviso-icono" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
          aria-hidden="true">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="16" x2="12" y2="12" />
          <line x1="12" y1="8" x2="12.01" y2="8" />
        </svg>
        <span class="aviso-texto">Al confirmar, los materiales volverán a estar disponibles para préstamo.</span>
      </div>
    </div>

    <!-- Footer con botones -->
    <div class="modal-footer-devolucion">
      <button class="btn-cancelar-devolucion" (click)="cerrarModalDevolucion()" [disabled]="procesandoDevolucion">
        Cancelar
      </button>
      <button class="btn-confirmar-devolucion" (click)="confirmarDevolucion()" [disabled]="procesandoDevolucion">
        {{ procesandoDevolucion ? 'Procesando...' : 'Confirmar Devolución' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL PERFIL USUARIO -->
<div class="modal-overlay" *ngIf="mostrarModalPerfil" (click)="cerrarModalPerfil()" role="dialog" aria-modal="true"
  aria-labelledby="titulo-perfil-pa">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Botón cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalPerfil()" aria-label="Cerrar modal">✕</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title" id="titulo-perfil-pa">Perfil del Alumno</h2>
    </div>

    <!-- Info del usuario -->
    <div class="perfil-contenido" *ngIf="usuarioPerfilSeleccionado">

      <!-- Card: Información Personal -->
      <div class="perfil-card">
        <div class="perfil-card-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>Información Personal</span>
        </div>
        <div class="perfil-card-body">
          <div class="perfil-field">
            <span class="perfil-label">Nombre completo</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.nombre }} {{ usuarioPerfilSeleccionado.apellidos
              }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Email</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.email }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Teléfono</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.telefono || 'No especificado' }}</span>
          </div>
        </div>
      </div>

      <!-- Card: Datos Académicos -->
      <div class="perfil-card">
        <div class="perfil-card-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
            <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
          </svg>
          <span>Datos Académicos</span>
        </div>
        <div class="perfil-card-body">
          <div class="perfil-field">
            <span class="perfil-label">Código de tarjeta</span>
            <span class="perfil-value perfil-codigo">{{ usuarioPerfilSeleccionado.codigo_tarjeta || 'Sin asignar'
              }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Estado del perfil</span>
            <span class="perfil-badge" [class.activo]="usuarioPerfilSeleccionado.estado_perfil === 'activo'"
              [class.bloqueado]="usuarioPerfilSeleccionado.estado_perfil === 'bloqueado'"
              [class.inactivo]="usuarioPerfilSeleccionado.estado_perfil === 'inactivo'">
              {{ usuarioPerfilSeleccionado.estado_perfil || 'Desconocido' }}
            </span>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalPerfil()">Cerrar</button>
    </div>

  </div>
</div>

<!-- MODAL: Notificación -->
<app-modal [mostrar]="mostrarModalNotificacion" [tipo]="tipoModalNotificacion" [titulo]="tituloModalNotificacion"
  [mensaje]="mensajeModalNotificacion" [textoBtnPrincipal]="'Aceptar'" (cerrar)="cerrarModalNotificacion()"></app-modal>