<!-- Pr√©stamos Activos PAS -->
<div class="prestamos-activos">

  <!-- Encabezado -->
  <div class="header">
    <h1 class="page-title">Pr√©stamos Activos</h1>
    <p class="page-subtitle">Listado de todos los pr√©stamos activos pendientes de devoluci√≥n</p>
  </div>

  <!-- Barra de Filtros -->
  <div class="filtros-container">
    <div class="busqueda-wrapper">
      <input type="text" class="input-busqueda" placeholder="Buscar por alumno (nombre, email, c√≥digo)..."
        [(ngModel)]="textoBusqueda" (input)="aplicarFiltros()" />
    </div>

    <div class="selects-wrapper">
      <!-- Bot√≥n Limpiar -->
      <button class="btn-limpiar" (click)="limpiarFiltros()" title="Limpiar b√∫squeda">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Tabla de pr√©stamos -->
  <div class="table-container">

    <!-- Header de la tabla -->
    <div class="table-header">
      <div class="th th-alumno sortable" (click)="ordenar('alumno')">
        Alumno
        <span class="sort-icon" [class.active]="sortColumn === 'alumno'">
          {{ sortColumn === 'alumno' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï' }}
        </span>
      </div>
      <div class="th th-tipo">Tipo</div>
      <div class="th th-material">Material</div>
      <div class="th th-fecha-prestamo">Fecha Pr√©stamo</div>
      <div class="th th-fecha-devolucion sortable" (click)="ordenar('fechaDevolucion')">
        Fecha Devoluci√≥n
        <span class="sort-icon" [class.active]="sortColumn === 'fechaDevolucion'">
          {{ sortColumn === 'fechaDevolucion' ? (sortDirection === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï' }}
        </span>
      </div>
      <div class="th th-accion">Acci√≥n</div>
    </div>

    <!-- Body de la tabla -->
    <div class="table-body">

      <!-- Loading -->
      <div class="empty-state" *ngIf="isLoading">
        <p>Cargando pr√©stamos...</p>
      </div>

      <!-- Error -->
      <div class="empty-state error" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Sin pr√©stamos -->
      <div class="empty-state" *ngIf="!isLoading && !errorMessage && prestamosFiltrados.length === 0">
        <p>No hay pr√©stamos activos que coincidan con la b√∫squeda</p>
      </div>

      <!-- Filas de pr√©stamos -->
      <div class="table-row" *ngFor="let prestamo of prestamosFiltrados" [class.vencido]="esVencido(prestamo)">
        <div class="td td-alumno">
          <a class="link-alumno" (click)="abrirPerfilAlumno(prestamo, $event)">
            {{ getNombreUsuario(prestamo) }}
          </a>
        </div>

        <!-- Columna: Tipo -->
        <div class="td td-tipo">
          <span class="badge-tipo">
            {{ getTipoTexto(prestamo.tipo) }}
          </span>
        </div>

        <!-- Columna: Material -->
        <div class="td td-material">
          <!-- Si tiene m√∫ltiples materiales, mostrar como enlace clickeable -->
          <span *ngIf="tieneMultiplesMateriales(prestamo)" class="material-link"
            (click)="verDetallesMateriales(prestamo, $event)">
            {{ getNombreMaterial(prestamo) }}
          </span>

          <!-- Si tiene un solo material, mostrar texto normal -->
          <span *ngIf="!tieneMultiplesMateriales(prestamo)">
            {{ getNombreMaterial(prestamo) }}
          </span>
        </div>

        <!-- Columna: Fecha Pr√©stamo -->
        <div class="td td-fecha-prestamo">
          {{ formatearFecha(prestamo.fecha_inicio) }}
        </div>

        <!-- Columna: Fecha Devoluci√≥n -->
        <div class="td td-fecha-devolucion">
          <span class="fecha-wrapper">
            <span class="icono-calendario" [class.vencido]="esVencido(prestamo)">
              üìÖ
            </span>
            {{ formatearFecha(prestamo.fecha_devolucion_prevista) }}
          </span>
        </div>

        <!-- Columna: Acci√≥n -->
        <div class="td td-accion">
          <button class="btn-devolucion" (click)="abrirModalDevolucion(prestamo)">
            Registrar Devoluci√≥n
          </button>
        </div>

      </div>

    </div>

  </div>

</div>

<!-- MODAL: Detalle de Materiales -->
<div class="modal-overlay" *ngIf="mostrarModalMateriales" (click)="cerrarModalMateriales()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Bot√≥n cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalMateriales()">‚úï</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title">Materiales del Pr√©stamo</h2>
    </div>

    <!-- Info del alumno -->
    <div class="modal-alumno" *ngIf="prestamoSeleccionado">
      <span class="alumno-label">Alumno:</span>
      <span class="alumno-nombre">{{ getNombreUsuario(prestamoSeleccionado) }}</span>
    </div>

    <!-- Lista de materiales -->
    <div class="materiales-lista">
      <div class="material-item" *ngFor="let item of materialesSeleccionados; let i = index">
        <div class="material-numero">{{ i + 1 }}</div>
        <div class="material-info">
          <div class="material-nombre">{{ getNombreItem(item) }}</div>
          <div class="material-detalles">
            <span class="material-tipo">{{ getTipoItem(item) }}</span>
            <span class="material-codigo">C√≥digo: {{ getCodigoItem(item) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalMateriales()">Cerrar</button>
    </div>

  </div>
</div>

<!-- MODAL: Confirmar Devoluci√≥n -->
<div class="modal-overlay" *ngIf="mostrarModalDevolucion" (click)="cerrarModalDevolucion()">
  <div class="modal-card modal-devolucion" (click)="$event.stopPropagation()">

    <!-- Bot√≥n cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalDevolucion()">‚úï</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title">Registrar Devoluci√≥n</h2>
    </div>

    <!-- Contenido -->
    <div class="devolucion-contenido" *ngIf="prestamoDevolucion">

      <!-- Info del alumno -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Alumno</div>
        <div class="seccion-valor">{{ getNombreUsuario(prestamoDevolucion) }}</div>
      </div>

      <!-- Tipo de pr√©stamo -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Tipo de Pr√©stamo</div>
        <div class="seccion-valor">
          <span class="badge-tipo-modal">{{ getTipoTexto(prestamoDevolucion.tipo) }}</span>
        </div>
      </div>

      <!-- Fecha de pr√©stamo -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Fecha de Pr√©stamo</div>
        <div class="seccion-valor">{{ formatearFecha(prestamoDevolucion.fecha_inicio) }}</div>
      </div>

      <!-- Fecha devoluci√≥n prevista -->
      <div class="devolucion-seccion">
        <div class="seccion-label">Fecha Devoluci√≥n Prevista</div>
        <div class="seccion-valor" [class.texto-vencido]="esVencido(prestamoDevolucion)">
          {{ formatearFecha(prestamoDevolucion.fecha_devolucion_prevista) }}
          <span class="badge-vencido" *ngIf="esVencido(prestamoDevolucion)">VENCIDO</span>
        </div>
      </div>

      <!-- Materiales a devolver -->
      <div class="devolucion-materiales">
        <div class="materiales-header">
          <span class="materiales-titulo">Materiales a Devolver</span>
          <span class="materiales-count">{{ getMaterialesDevolucion().length }}</span>
        </div>

        <div class="materiales-lista-devolucion">
          <div class="material-devolucion-item" *ngFor="let item of getMaterialesDevolucion()">
            <div class="material-datos">
              <span class="material-nombre">{{ getNombreItem(item) }}</span>
              <span class="material-codigo">{{ getCodigoItem(item) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje de confirmaci√≥n -->
      <div class="devolucion-aviso">
        <span class="aviso-icono">‚ÑπÔ∏è</span>
        <span class="aviso-texto">Al confirmar, los materiales volver√°n a estar disponibles para pr√©stamo.</span>
      </div>
    </div>

    <!-- Footer con botones -->
    <div class="modal-footer-devolucion">
      <button class="btn-cancelar-devolucion" (click)="cerrarModalDevolucion()" [disabled]="procesandoDevolucion">
        Cancelar
      </button>
      <button class="btn-confirmar-devolucion" (click)="confirmarDevolucion()" [disabled]="procesandoDevolucion">
        {{ procesandoDevolucion ? 'Procesando...' : 'Confirmar Devoluci√≥n' }}
      </button>
    </div>
  </div>
</div> 

<!-- MODAL PERFIL USUARIO -->
<div class="modal-overlay" *ngIf="mostrarModalPerfil" (click)="cerrarModalPerfil()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <!-- Bot√≥n cerrar -->
    <button class="btn-cerrar" (click)="cerrarModalPerfil()">‚úï</button>

    <!-- Header del modal -->
    <div class="modal-header">
      <h2 class="modal-title">Perfil del Alumno</h2>
    </div>

    <!-- Info del usuario -->
    <div class="perfil-contenido" *ngIf="usuarioPerfilSeleccionado">

      <!-- Card: Informaci√≥n Personal -->
      <div class="perfil-card">
        <div class="perfil-card-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>Informaci√≥n Personal</span>
        </div>
        <div class="perfil-card-body">
          <div class="perfil-field">
            <span class="perfil-label">Nombre completo</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.nombre }} {{ usuarioPerfilSeleccionado.apellidos
              }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Email</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.email }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Tel√©fono</span>
            <span class="perfil-value">{{ usuarioPerfilSeleccionado.telefono || 'No especificado' }}</span>
          </div>
        </div>
      </div>

      <!-- Card: Datos Acad√©micos -->
      <div class="perfil-card">
        <div class="perfil-card-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
            <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
          </svg>
          <span>Datos Acad√©micos</span>
        </div>
        <div class="perfil-card-body">
          <div class="perfil-field">
            <span class="perfil-label">C√≥digo de tarjeta</span>
            <span class="perfil-value perfil-codigo">{{ usuarioPerfilSeleccionado.codigo_tarjeta || 'Sin asignar'
              }}</span>
          </div>
          <div class="perfil-field">
            <span class="perfil-label">Estado del perfil</span>
            <span class="perfil-badge" [class.activo]="usuarioPerfilSeleccionado.estado_perfil === 'activo'"
              [class.bloqueado]="usuarioPerfilSeleccionado.estado_perfil === 'bloqueado'"
              [class.inactivo]="usuarioPerfilSeleccionado.estado_perfil === 'inactivo'">
              {{ usuarioPerfilSeleccionado.estado_perfil || 'Desconocido' }}
            </span>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-cerrar-modal" (click)="cerrarModalPerfil()">Cerrar</button>
    </div>

  </div>
</div>

<!-- MODAL: Notificaci√≥n -->
<app-modal [mostrar]="mostrarModalNotificacion" [tipo]="tipoModalNotificacion" [titulo]="tituloModalNotificacion"
  [mensaje]="mensajeModalNotificacion" [textoBtnPrincipal]="'Aceptar'" (cerrar)="cerrarModalNotificacion()"></app-modal>